<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 在 ASP.NET 中使用生成 Swagger 文档和 Typescript 客户端程序 · wangb's blog</title><meta name="description" content="在 ASP.NET 中使用生成 Swagger 文档和 Typescript 客户端程序 - wangb"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://wangbinyq.github.io/atom.xml" title="wangb's blog"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="wangb's blog" type="application/atom+xml">
<!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wangbinyq" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">在 ASP.NET 中使用生成 Swagger 文档和 Typescript 客户端程序</h1><div class="post-info">Sep 23, 2021</div><div class="post-content"><p>本文将使用 ASP.NET 创建一个 WebApi 程序, 并使用 <a target="_blank" rel="noopener" href="https://www.nuget.org/packages?q=Swashbuckle"><code>Swashbuckle</code></a> 生成 Swagger 文档和对应的 Typescript 客户端程序, 同时创建一个 <code>Angular</code> 客户端程序调用生成的 Api. 示例代码在 <a target="_blank" rel="noopener" href="https://github.com/wangbinyq/aspnet-swagger-codegen-example">aspnet-swagger-codegen-example</a>.</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><span id="more"></span>

<h2><span id="webapi-程序">WebApi 程序</span></h2><p>首先使用 <code>dotnet cli</code> 创建一个 WebApi 程序:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dotnet new webapi -o Swagger</span><br></pre></td></tr></table></figure>

<p>可以看到 WebApi 的模板已经自动帮我们设置好了 Swagger.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddSwaggerGen(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.SwaggerDoc(&quot;v1&quot;, new() &#123; Title = &quot;Swagger&quot;, Version = &quot;v1&quot; &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">if (app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseSwagger();</span><br><span class="line">    app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;Swagger v1&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在开始之前, 先对 <code>appsettings.json</code> 添加 <code>Urls</code> 配置:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Urls&quot;</span>: <span class="string">&quot;http://localhost:5001&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们固定 Api 程序的监听端口, 方便后面客户端使用. 现在我们通过命令 <code>dotnet watch run</code> 启动程序. NET6 中使用 <code>watch</code> 命令可以获得 <code>hot reload</code> 支持. 在浏览器中打开 <code>http://localhost:5001/swagger/index.html</code> 可以看到自带的 <code>WeatherForecast</code> 的接口文档了.</p>
<p>点击接口可以看到接口定义的出参入参, 再点击 <code>Try it out</code> 然后点击 <code>Execute</code>, <code>Responses</code> 中就显示接口返回的数据.</p>
<p><img src="%22/image/aspnet-openapi/swagger-1.png" alt="接口返回数据"></p>
<h3><span id="添加接口">添加接口</span></h3><p>在 <code>Models</code> 文件夹中定义新接口的模型: <code>CountResponse.cs</code> 和 <code>CountPostResponse.cs</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">namespace Swagger.Models;</span><br><span class="line"></span><br><span class="line">public class CountResponse</span><br><span class="line">&#123;</span><br><span class="line">    public int Count &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">namespace Swagger.Models;</span><br><span class="line"></span><br><span class="line">public class CountPostRequest</span><br><span class="line">&#123;</span><br><span class="line">    public int Add &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Controllers</code> 文件夹中添加 <code>CountController.cs</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Swagger.Models;</span><br><span class="line"></span><br><span class="line">namespace Swagger.Controllers;</span><br><span class="line"></span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;[controller]&quot;)]</span><br><span class="line">public class CountController</span><br><span class="line">&#123;</span><br><span class="line">    private static int _count = 0;</span><br><span class="line"></span><br><span class="line">    [HttpGet]</span><br><span class="line">    public CountResponse Get()</span><br><span class="line">    &#123;</span><br><span class="line">        return new CountResponse</span><br><span class="line">        &#123;</span><br><span class="line">            Count = _count</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPost]</span><br><span class="line">    public CountResponse Post(CountPostRequest req)</span><br><span class="line">    &#123;</span><br><span class="line">        Interlocked.Add(ref _count, req.Add);</span><br><span class="line"></span><br><span class="line">        return new CountResponse</span><br><span class="line">        &#123;</span><br><span class="line">            Count = _count</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刷新浏览器, 就可以看到新添加的接口已经存在了</p>
<p><img src="%22/image/aspnet-openapi/swagger-2.png" alt="新接口"></p>
<h2><span id="客户端程序">客户端程序</span></h2><p>首先我们修改 <code>cjproj</code> 文件, 添加如下字段</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Watch</span> <span class="attr">Remove</span>=<span class="string">&quot;Client\**\*&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Watch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样 <code>watch</code> 命令就不会监听客户端程序文件的变动, 然后输入命令 <code>ng new Client</code> 添加一个 <code>Angular</code> 程序. 接下来我们配置 <code>Angular</code> 的代理服务器. 在 <code>Client</code> 根目录下新建文件 <code>proxy.conf.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;/api&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;http://localhost:5001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;pathRewrite&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 <code>angular.json</code>, 添加 <code>proxyConfig</code> 项:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;architect&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;serve&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;builder&quot;</span>: <span class="string">&quot;@angular-devkit/build-angular:dev-server&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;proxyConfig&quot;</span>: <span class="string">&quot;proxy.conf.json&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过 <code>yarn start</code> 启动.</p>
<h2><span id="swagger-codegen">Swagger CodeGen</span></h2><p>生成 Api 客户端代码的方式有许多, 可以使用工具从 OpenAPI 文档生成, 另外就是使用 <a target="_blank" rel="noopener" href="https://github.com/RicoSuter/NSwag/wiki/TypeScriptClientGenerator"><code>NSwag.CodeGeneration.TypeScript</code></a> 直接从代码生成.</p>
<p>先来看工具生成的方式, 我们选择的是 <a target="_blank" rel="noopener" href="https://github.com/RicoSuter/NSwag/wiki/NSwagStudio"><code>NSwagStudio</code></a> 来生成 Api 的客户端代码. 从该<a target="_blank" rel="noopener" href="https://github.com/RicoSuter/NSwag/wiki/NSwagStudio">链接</a>下载并安装 <code>NSwagStudio</code>. 打开 <code>NSwagStduio</code> 后, 左边是 OpenAPI 定义的输入, 右边是客户端生成程序的输出. 我们选择使用 <code>OpenAPI/Swagger Specification</code> 作为输入, 在 <code>URL</code> 中填写我们的 OpenAPI 定义 json 文件路径 <code>http://localhost:5001/swagger/v1/swagger.json</code>, 然后勾选 <code>Typescript Client</code> 作为输出, <code>Template</code> 选择 <code>Angular</code>. 最后点击 <code>Generate Output</code></p>
<p><img src="%22/image/aspnet-openapi/swagger-3.png" alt="NSwagStudio"></p>
<p>然后复制右边 <code>Output</code> 标签中的内容到 <code>Client/client.ts</code> 中保存.</p>
<p>在我们调用接口之前还需要做一点设置, 即注入 <code>API_BASE_URL</code> 和 <code>Client</code>, 修改 <code>app.module.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [</span><br><span class="line">    AppComponent,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    BrowserModule,</span><br><span class="line">    HttpClientModule,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123; <span class="attr">provide</span>: API_BASE_URL, <span class="attr">useValue</span>: <span class="string">&#x27;/api&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">provide</span>: Client &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [AppComponent]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>现在我们就可以在 <code>Angular</code> 中调用 <code>WebApi</code> 的接口了. 修改 <code>app.component.html</code> 和 <code>app.component.ts</code> 为:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  count: &#123;&#123; (count$ | async)?.count &#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;postCount(1)&quot;</span>&gt;</span>+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;postCount(10)&quot;</span>&gt;</span>+10<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;  tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Client, CountResponse &#125; <span class="keyword">from</span> <span class="string">&#x27;src/client&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-root&#x27;</span>,</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./app.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrls</span>: [<span class="string">&#x27;./app.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  title = <span class="string">&#x27;Client&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  count$?: Observable&lt;CountResponse&gt;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> client: Client</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">ngOnInit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.count$ = <span class="built_in">this</span>.client.countGET()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.count$ = <span class="built_in">this</span>.client.countGET()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">postCount</span>(<span class="params">add: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.client.countPOST(&#123;</span><br><span class="line">      add,</span><br><span class="line">    &#125;).pipe(</span><br><span class="line">      tap(<span class="function">() =&gt;</span> <span class="built_in">this</span>.getCount())</span><br><span class="line">    ).subscribe()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就获得类型安全的客户端 Api 代码.</p>
</div></article></div></main><footer><div class="paginator"><a href="/addtransient-addscoped-addsingleton/" class="prev">PREV</a><a href="/ng-di/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'wangb';
var disqus_identifier = 'openapi-codegen-aspnet/';
var disqus_title = '在 ASP.NET 中使用生成 Swagger 文档和 Typescript 客户端程序';
var disqus_url = 'https://wangbinyq.github.io/openapi-codegen-aspnet/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wangb.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2021 <a href="https://wangbinyq.github.io">wangb</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-114732129-1",'auto');ga('send','pageview');</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>