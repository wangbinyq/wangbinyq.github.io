<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> DNS 解析详解 · wangb's blog</title><meta name="description" content="DNS 解析详解 - wangb"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://wangbinyq.github.io/atom.xml" title="wangb's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wangbinyq" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">DNS 解析详解</h1><div class="post-info">Feb 28, 2018</div><div class="post-content"><p>大家都知道 DNS (Domain Name System, 域名系统), 是一个域名和 IP 地址映射系统. 通过 DNS 我们可以根据比较容易记住的域名而不是数字 IP 地址来访问网络资源.<br>本文主要使用 <code>dig</code> (ubuntu 上可以通过 <code>sudo apt install dnsutils</code> 安装) 工具来了解 DNS 的各方面.<br><a id="more"></a></p>
<h2><span id="0x01-cname-和-a-记录">0x01 CNAME 和 A 记录</span></h2><p>在 DNS 中, A 记录值表示的是真正的 IP 地址, 而 CNAME 相当于域名的别名.<br>我们来看一个例子, 新浪的 DNS 解析:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> dig www.sina.com.cn</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 45272</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.sina.com.cn.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.sina.com.cn.	0	IN	CNAME	spool.grid.sinaedge.com.</span><br><span class="line">spool.grid.sinaedge.com. 280	IN	A	222.73.28.96</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:37:11 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 97</span><br></pre></td></tr></table></figure>
<p>其中 <code>QUESTION SECTION:</code> 表示我们要查找的是 <code>www.sina.com.cn</code> 的 A 记录, <code>ANSWER SECTION:</code> 返回了记录的结果.<br>这个查询返回了三条记录, 每条记录有五个字段分别代表了: 主机域名, TTL, 类型(IN 表示 Internet), DNS 记录类型以及记录值. DNS 记录类型如下图所示 (图片来自阿里云截图):</p>
<p><img src="/images/dns/dns record.png" alt="dns record"></p>
<p><code>www.sina.com.cn</code> 有一个 CNAME和一个 A记录. 如果我们直接在浏览器中访问 CNAME 值或者 IP 地址, 会发现不能访问.</p>
<p><img src="/images/dns/error.png" alt="error"></p>
<p>这是因为新浪服务器拒绝了非 <code>www.sina.com.cn</code> 域名访问. 我们可以构造一个 HTTP header 来实现直接连接 IP 访问新浪:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl 222.73.28.96 -H "Host: www.sina.com.cn"</span><br></pre></td></tr></table></figure></p>
<p>这样就能返回正常的页面.</p>
<h2><span id="0x02-另一个例子">0x02 另一个例子</span></h2><p>再来看一个例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ dig baidu.com                    </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; baidu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 23153</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;baidu.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">baidu.com.		300	IN	A	111.13.101.208</span><br><span class="line">baidu.com.		300	IN	A	123.125.114.144</span><br><span class="line">baidu.com.		300	IN	A	220.181.57.216</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:53:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 86</span><br></pre></td></tr></table></figure>
<p>我们看到 <code>baidu.com</code> 返回了三个 A 记录地址. 那客户端应该选择哪一个作为服务器的 IP 地址呢?<br>这个需要看客户端的实现, 比如使用 <code>gethostbyname</code> 的话会选择一个 IP 地址返回,  <code>getaddrinfo</code> 会返回所有的地址.</p>
<h2><span id="0x03-ns-记录">0x03 NS 记录</span></h2><p>NS 记录是域名服务器记录，用来指定域名由哪个DNS服务器来进行解析.</p>
<p><code>dig</code> 可以添加 <code>+trace</code> 参数来获取完整 DNS 解析过程. 还是通过 <code>www.sina.com.cn</code> 作为例子.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> dig www.sina.com.cn +trace</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn +trace</span><br><span class="line">;; global options: +cmd</span><br><span class="line">.			3600	IN	NS	d.root-servers.net.</span><br><span class="line">.			3600	IN	NS	e.root-servers.net.</span><br><span class="line">.			3600	IN	NS	f.root-servers.net.</span><br><span class="line">.			3600	IN	NS	g.root-servers.net.</span><br><span class="line">.			3600	IN	NS	h.root-servers.net.</span><br><span class="line">.			3600	IN	NS	i.root-servers.net.</span><br><span class="line">.			3600	IN	NS	j.root-servers.net.</span><br><span class="line">.			3600	IN	NS	k.root-servers.net.</span><br><span class="line">.			3600	IN	NS	l.root-servers.net.</span><br><span class="line">.			3600	IN	NS	m.root-servers.net.</span><br><span class="line">.			3600	IN	NS	a.root-servers.net.</span><br><span class="line">.			3600	IN	NS	b.root-servers.net.</span><br><span class="line">.			3600	IN	NS	c.root-servers.net.</span><br><span class="line">;; Received 1771 bytes from 192.168.1.6#53(192.168.1.6) in 0 ms</span><br><span class="line"></span><br><span class="line">cn.			172800	IN	NS	b.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	ns.cernet.net.</span><br><span class="line">cn.			172800	IN	NS	c.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	d.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	a.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	g.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	f.dns.cn.</span><br><span class="line">cn.			172800	IN	NS	e.dns.cn.</span><br><span class="line">cn.			86400	IN	DS	41470 8 2 3623FB6E3B1F69C6855DA1E48D3A38236DD2EDF0380FB018FF538650 EAC2C4DD</span><br><span class="line">cn.			86400	IN	DS	57724 8 2 5D0423633EB24A499BE78AA22D1C0C9BA36218FF49FD95A4CDF1A4AD 97C67044</span><br><span class="line">cn.			86400	IN	RRSIG	DS 8 1 86400 20180313050000 20180228040000 41824 . GbRg9UYKus5nqvJxCKVZTaX5j2WYaF2c3jH5XOEPzqgcGp23+U941ZHz nKAXTv8oJq2+dJiRuVnwAD7c+Ge8MBJbd+tpw0jcQ3zs3SiocVhWgF3/ Bjig8ouJsuKukEuF89tx+oqbYjRrau9PFNJBoN2zlVZP1JQYTukYaGeY aK91OtgRuC1yVVQqNstLhU+YWyi7gNKOd31SMSpyvUZDIf+8wQrR6j9y dUb7zex8dk+XFS9/NqOXi6kRQxOPdflXXGieNZRVAnHfKdgO3LsXYmsD 92CY9G7cwj9XShFdYq7GLSirh3c9LvUR4E0VKk6qcr3usgKbmDPumyAv aN+ZwA==</span><br><span class="line">;; Received 754 bytes from 192.33.4.12#53(c.root-servers.net) in 173 ms</span><br><span class="line"></span><br><span class="line">sina.com.cn.		86400	IN	NS	ns3.sina.com.cn.</span><br><span class="line">sina.com.cn.		86400	IN	NS	ns2.sina.com.cn.</span><br><span class="line">sina.com.cn.		86400	IN	NS	ns1.sina.com.cn.</span><br><span class="line">sina.com.cn.		86400	IN	NS	ns4.sina.com.cn.</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN NSEC3	1 1 10 AEF123AB HIO2MHL5BSKBHFFRA5I1J58SU91CDLLA NS SOA RRSIG DNSKEY NSEC3PARAM</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN RRSIG	NSEC3 8 3 21600 20180318092826 20180216084403 48018 com.cn. iuUIwe/vd4QLsTo8behQVf8ZPWaU9JsP+gxrUHop+oybuZH+II+kvOBW wTfGHap/n3C7iSevN80Wa2eFeH0QBWif2A30+zfg9hCzVjEEUDulmc1a 4+ltDbv4UZVJpBPRU7n2AgW4UMK/q0vyWqV6oKwmIygj58fhrMkqcrpR CpU=</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN NSEC3	1 1 10 AEF123AB UQROTQK62NOIM5U43DMF7AMC8JJFRM7T NS DS RRSIG</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN RRSIG	NSEC3 8 3 21600 20180311113832 20180209104700 48018 com.cn. I1zxGBgSFJfq5GCrwlukCCkWNeQRcJJu9ydX5OgoH0mdYwVVLGoB2y1D htn8lGc4MMfdbY+zTdlnvYvBHdtFSS2+2eq+ficKzzZQ2CVtDrFm91Eo 0MK+BavvLcE5pkRpIfpI9FIIMrlNaj9cOBwWNR2g1yXfSYWSr5NUFKQG voE=</span><br><span class="line">;; Received 679 bytes from 203.119.25.1#53(a.dns.cn) in 33 ms</span><br><span class="line"></span><br><span class="line">www.sina.com.cn.	0	IN	CNAME	spool.grid.sinaedge.com.</span><br><span class="line">;; Received 81 bytes from 61.172.201.254#53(ns2.sina.com.cn) in 5 ms</span><br></pre></td></tr></table></figure>
<p>我们最上面域名为 <code>.</code> (根域名) 的 NS 记录, 一共有 13 条, 代表了 13 台根域名服务器. 接下来是在根域名服务器上查询 <code>cn.</code> (实际中最后一个点去掉) 得到的 8 条 NS 记录, 代表了顶级域名服务器. 然后是顶级域名服务器查询 <code>sina.com.cn</code> 得到的 4 条 NS 记录, 代表了授权域名服务器, 最后授权 DNS 返回了 <code>www.sina.com.cn</code> 的 CNAME 记录.</p>
<div class="tip"><br>授权域名服务器: 我们知道计算机要上网的话, 必须要设置 DNS (除非只用 IP), 或者 ISP 自动分配 DNS. 这个 DNS 服务器是叫做 LocalDNS, 提供了缓存和递归查询服务. 如果查询一个域名在 LocalDNS 上已经有缓存了, LocalDNS 直接返回结果 (叫做非授权应答); 如果 LocalDNS 上没有这个域名的话, LocalDNS 就要对域名发起递归查找(类似 dig +trace 的过程), 就是从根域名 -&gt; 顶级域名 -&gt; 授权域名查找这个域名, 并将应答返回, 同时缓存应答(可以看出根域名, 顶级域名也是授权域名服务器). 一般宽带运行商和公共DNS服务提供的是 LocalDNS, 域名注册商提供的是授权DNS.<br></div>

<p>假如我在阿里云上注册了一个域名 (example.com), 其 NS 记录就是 dns14.hichina.com 和 dns13.hichina.com (万网的授权域名服务器), 我们还可以设置 NS 记录指向其他的授权域名服务器.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/17/how-to-write-an-anime-library/" class="prev">PREV</a><a href="/2018/02/28/hexo-guide/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'wangb';
var disqus_identifier = '2018/02/28/dns/';
var disqus_title = 'DNS 解析详解';
var disqus_url = 'https://wangbinyq.github.io/2018/02/28/dns/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//wangb.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 <a href="https://wangbinyq.github.io">wangb</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
});</script><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-114732129-1",'auto');ga('send','pageview');</script></body></html>