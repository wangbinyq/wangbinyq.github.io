<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wangb&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wangbinyq.github.io/"/>
  <updated>2018-11-23T09:25:01.650Z</updated>
  <id>https://wangbinyq.github.io/</id>
  
  <author>
    <name>wangb</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Angular 依赖注入详解</title>
    <link href="https://wangbinyq.github.io/2018/11/22/ng-di/"/>
    <id>https://wangbinyq.github.io/2018/11/22/ng-di/</id>
    <published>2018-11-22T08:54:00.000Z</published>
    <updated>2018-11-23T09:25:01.650Z</updated>
    
    <content type="html"><![CDATA[<p><code>Angular</code> 程序开发中 <code>Provider</code> 和依赖注入是两个非常重要的概念, 关系到我们如何编写程序. 本文将解释 <code>@Inject()</code>, <code>@Injectable()</code> 两个装饰器背后的原理和它们的使用场景, 以及 <code>Angular</code> 依赖注入框架中的 <code>token</code>, <code>provider</code> 和 <code>Angular</code> 是如何创建依赖的.<br><a id="more"></a></p><h2><span id="注入-providers">注入 providers</span></h2><p><code>Angular</code> 的依赖注入背后有很多魔法发生. <code>Angular 1.x</code> 时代我们可以通过字符串 token 来获取指定的依赖.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SomeController</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// use $scope</span></span><br><span class="line">&#125;</span><br><span class="line">SomeController.$inject = [<span class="string">'$scope'</span>]</span><br></pre></td></tr></table></figure><p>你可以通过之前的<a href="https://toddmotto.com/angular-js-dependency-injection-annotation-process/" target="_blank" rel="noopener">文章</a>来获取更多信息.</p><p>虽然这种方式曾经很好, 但是也存在一些缺陷. 通常我们会通过创建各种模块 (<code>Module</code>) 和引用其他模块 (比如 <code>ui-router</code>) 来构建我们的程序. 不同的模块中的 controllers/services 不能用相同的名字, 否则就会发成冲突.</p><p>幸运的是,新的  <code>Angular</code> 重写了依赖注入系统, 使其更强大更灵活.</p><h3><span id="新的依赖注入系统">新的依赖注入系统</span></h3><p>当需要注入服务 (<code>provider</code>) 到组件或其他服务中时, 我们在构造函数中指定需要注入的类型. 比如:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'exmaple-component'</span>,</span><br><span class="line">  template: <span class="string">'&lt;div&gt;I am a component&lt;/div&gt;'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> ExampleComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: Http</span>) &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入的类型标记为 <code>Http</code>, <code>Angular</code> 能自动将其赋值给 <code>http</code>.</p><p>这看起来非常的神奇. 类型标记只在 <code>TypeScript</code> 中存在, 当程序转译成 <code>JavaScript</code> 并在浏览器中运行时, 我们对 <code>http</code> 参数毫无所知 (在运行时 <code>http</code> 可以为任何对象).</p><p>我们需要将 <code>tsconfig.json</code> 中的 <code>emitDecoratorMetadata</code> 设成 <code>true</code>. 这样在转译后的 <code>JavaScript</code> 的代码中, 会将参数类型加到装饰器上.</p><p>我们来看转译后的 <code>JavaScript</code> 代码 (ES6):</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ExampleComponent = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ExampleComponent</span>(<span class="params">http</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.http = http;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ExampleComponent;</span><br><span class="line">&#125;)();</span><br><span class="line">ExampleComponent = __decorate(</span><br><span class="line">  [</span><br><span class="line">    Component(&#123;</span><br><span class="line">      selector: <span class="string">'example-component'</span>,</span><br><span class="line">      template: <span class="string">'&lt;div&gt;I am a component&lt;/div&gt;'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    __metadata(<span class="string">'design:paramtypes'</span>, [Http]),</span><br><span class="line">  ],</span><br><span class="line">  ExampleComponent</span><br><span class="line">);<span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  selector: <span class="string">'exmaple-component'</span>,</span><br><span class="line">  template: <span class="string">'&lt;div&gt;I am a component&lt;/div&gt;'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(private http: Http) &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们能看到转译后的代码中 <code>http</code> 对应上了 <code>@angualr/http</code> 中的 <code>Http</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__metadata(<span class="string">'design:paramtypes'</span>, [Http]);</span><br></pre></td></tr></table></figure><p>最终 <code>@Component</code> 装饰器转译成了 ES 代码, 并通过 <code>__decorate</code> 附加了一些元信息 <code>metadata</code>. 这些信息能告诉 <code>Angular</code> 要将 <code>Http</code> 传递给组件的构造函数, 并最终赋值给 <code>this.http</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExampleComponent</span>(<span class="params">http</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.http = http;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>metadata</code> 实现了 <code>$inject</code> 中功能, 但是这里作为 <code>token</code> 的是类而不是字符串. 命名冲突就不会发生了.</p><p><div class="tip"><br>你可能已经听过 token (或者 OpaqueToken) 的概念. Angular 使用 token 来存储或获取 providers. Token 作为 key 来引用 (hash?) provider. 不同于传统的 key, token 可以是任何值作为 key (对象, 字符串, 类等).</div></p><div><h3><span id="inject"><code>@Inject()</code></span></h3><p>所以 <code>@Inject</code> 起什么作用呢? 我们将组件改写成:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'example-component'</span>,</span><br><span class="line">  template: <span class="string">'&lt;div&gt;I am a component&lt;/div&gt;'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> ExampleComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@Inject</span>(Http) <span class="keyword">private</span> http</span>) &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这一次, 我们通过 <code>@Inject</code> 手动提供 <code>token</code>.</p><p>如果组件或服务需要很多依赖, 这样写会非常的麻烦. <code>Angular</code> 可以通过 <code>metadata</code> 自动找到依赖, 所有大多数情况下我们都不需要使用 <code>@Inject</code>.</p><p>唯一需要 <code>@Inject</code> 的情况是在同时使用 <code>OpaqueToken</code> 对象时.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myToken = <span class="keyword">new</span> OpaqueToken(<span class="string">'myValue'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(...)</span><br><span class="line"><span class="keyword">class</span> ExampleComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> token: myToken</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里 <code>myToken</code> 不是类型, 而是值. 这意味着上面的代码会报错. 但是使用 <code>@Inject</code> 的话就可以了:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myToken = <span class="keyword">new</span> OpaqueToken(<span class="string">'myValue'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(...)</span><br><span class="line"><span class="keyword">class</span> ExampleComponent &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="meta">@Inject</span>(myToken) <span class="keyword">private</span> token</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在不会深入 <code>OpaqueToken</code>, 但是上面的例子足够表明 <code>@Inject</code> 的作用.</p><h3><span id="injectable"><code>@Injectable()</code></span></h3><p>我们并不需要在所有的类上添加 <code>@Injectable</code> 装饰器, 才可以将其注入到组件或服务中. 虽然可能会发生变化, 有一个 <a href="https://github.com/angular/angular/issues/13820" target="_blank" rel="noopener">issue</a> 讨论需要强制加上 <code>@Injectable</code> (4.0 已经变成强制需要 <code>@Injectable</code>)</p><p>当我们使用装饰器时, 将被装饰的类的元信息存储成能被 <code>Angular</code> 处理的格式, 这些元信息中就包含了这个类的依赖.</p><p>如果没有使用装饰器添加元信息, <code>Angular</code> 就无从得知类的依赖. 这就是我们为什么需要 <code>@Injectable()</code>. <code>@Injectable()</code> 并没有其他的功能, 仅仅是提供了一些元信息.</p><h2><span id="token-和依赖注入">Token 和依赖注入</span></h2><p>现在我们知道了如何告诉 <code>Angular</code> 需要注入的内容, 现在我们来学习 <code>Angular</code> 如何知道从哪获取依赖以及如何实例化他们.</p><h3><span id="注册-provide">注册 provide</span></h3><p>我们先来看如何注册一个服务到一个 <code>NgModule</code> 上.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  providers: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> ExampleModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>上面例子是下面的简化版:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  providers: [&#123;</span><br><span class="line">    provide: AuthService,</span><br><span class="line">    useClass: AuthService</span><br><span class="line">  &#125;],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> ExampleModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>provide</code> 字段表示我们注册的 provider 的 <code>token</code>. 当 <code>Angular</code> 看到 <code>AuthService</code> <code>token</code> 时, 就会取 <code>useClass</code> 的值进行实例化.</p><p>这样做有很多优点. 其一, 我们可以注册多个相同 <code>class</code> 的 <code>provide</code>, 而且不会发生冲突 (只要 <code>token</code> 不一样); 第二, 我们可以通过相同的 <code>token</code> 来覆盖之前的 <code>provide</code>.</p><h3><span id="覆盖-providers">覆盖 <code>providers</code></span></h3><p>我们的 <code>AuthService</code> 代码如下:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">'@angular/http'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> http: Http</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  authenticateUser(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>): Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// returns true or false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.post(<span class="string">'/api/auth'</span>, &#123; username, password &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getUsername(): Observable&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.http.post(<span class="string">'/api/user'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设我们的程序中使用了这个服务, 例如登录:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'auth-login'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;button (click)="login()"&gt;</span></span><br><span class="line"><span class="string">      Login</span></span><br><span class="line"><span class="string">    &lt;/button&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> LoginComponent &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> authService: AuthService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  login() &#123;</span><br><span class="line">    <span class="keyword">this</span>.authService</span><br><span class="line">      .authenticateUser(<span class="string">'toddmotto'</span>, <span class="string">'straightouttacompton'</span>)</span><br><span class="line">      .subscribe(<span class="function">(<span class="params">status: <span class="built_in">boolean</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// do something if the user has logged in</span></span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>显示用户名:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">'user-info'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      You are &#123;&#123; username &#125;&#125;!</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> UserInfoComponent <span class="keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  username: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> authService: AuthService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">    <span class="keyword">this</span>.authService</span><br><span class="line">      .getUsername()</span><br><span class="line">      .subscribe(<span class="function">(<span class="params">username: <span class="built_in">string</span></span>) =&gt;</span> <span class="keyword">this</span>.username = username);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将上面所有代码整合成一个模块, 比如 <code>AuthModule</code>:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">'./login.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserInfoComponent &#125; <span class="keyword">from</span> <span class="string">'./user-info.component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  declarations: [LoginComponent, UserInfoComponent],</span><br><span class="line">  providers: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>其他的组件可能也会依赖 <code>AuthService</code>. 现在假设我们有一个新的需求, 需要修改授权方法使得用户可以通过 Facebook 登录.</p><p>一种方法是修改所有的组件, 将其构造函数中的 <code>AuthService</code> 替换成新的服务. 另外我们也可以通过修改 <code>providers</code> 来将 <code>AuthService</code> 覆盖成 <code>FacebookAuthService</code>:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// totally made up</span></span><br><span class="line"><span class="keyword">import</span> &#123; FacebookAuthService &#125; <span class="keyword">from</span> <span class="string">'@facebook/angular'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">'./login.component'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserInfoComponent &#125; <span class="keyword">from</span> <span class="string">'./user-info.component'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  declarations: [LoginComponent, UserInfoComponent],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: AuthService,</span><br><span class="line">      useClass: FacebookAuthService,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>这里我们没有采用简写方法, 并且替换了 <code>useClass</code> 的值. 这样在模块中的 <code>AuthService</code> <code>token</code> 就会使用 <code>FacebookAuthService</code> 类.</p><h2><span id="理解注入器-injector">理解注入器 (Injector)</span></h2><p>翻译略 (一些 AOT 源码的解释, 有兴趣的可以研究下).</p><h2><span id="参考资料">参考资料</span></h2><ul><li><a href="http://blog.wolksoftware.com/decorators-reflection-javascript-typescript" target="_blank" rel="noopener">装饰器反射相关4篇</a></li></ul></div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Angular&lt;/code&gt; 程序开发中 &lt;code&gt;Provider&lt;/code&gt; 和依赖注入是两个非常重要的概念, 关系到我们如何编写程序. 本文将解释 &lt;code&gt;@Inject()&lt;/code&gt;, &lt;code&gt;@Injectable()&lt;/code&gt; 两个装饰器背后的原理和它们的使用场景, 以及 &lt;code&gt;Angular&lt;/code&gt; 依赖注入框架中的 &lt;code&gt;token&lt;/code&gt;, &lt;code&gt;provider&lt;/code&gt; 和 &lt;code&gt;Angular&lt;/code&gt; 是如何创建依赖的.&lt;br&gt;
    
    </summary>
    
    
      <category term="angular frontend di" scheme="https://wangbinyq.github.io/tags/angular-frontend-di/"/>
    
  </entry>
  
  <entry>
    <title>how to write an anime library</title>
    <link href="https://wangbinyq.github.io/2018/04/17/how-to-write-an-anime-library/"/>
    <id>https://wangbinyq.github.io/2018/04/17/how-to-write-an-anime-library/</id>
    <published>2018-04-17T05:42:11.000Z</published>
    <updated>2018-11-22T08:27:11.357Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="the-engine">The engine</span></h2><p>We need a mechanism to deal with <a href="https://github.com/wangbinyq/writings/wiki/Html-Reflow-and-Layout-Thrashing" target="_blank" rel="noopener">layout thrashing</a>. So we have an engine that group all animations into to a <code>requestAnimationFrame</code> callback.<br><a id="more"></a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> engine = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> animations = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> raf = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">play</span> (<span class="params"></span>) </span>&#123; raf = requestAnimationFrame(step) &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">step</span> (<span class="params"></span>) </span>&#123; animations.forEach(<span class="function">(<span class="params">anim</span>) =&gt;</span> anim.step()); <span class="keyword">if</span> (animations.length) play() &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">anim</span>) </span>&#123; animations.push(anim) &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">remove</span> (<span class="params">anim</span>) </span>&#123; <span class="keyword">const</span> index = animations.indexOf(index); animations.splice(index, <span class="number">1</span>) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    play, step, add, remove, raf</span><br><span class="line">  &#125; </span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h2><span id="the-tween-and-animation">The tween and animation</span></h2><p>A tween object repersent a property change. It is an object like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const defaultTweenSetting = &#123;</span><br><span class="line">  target: Element,</span><br><span class="line">  property: string,</span><br><span class="line">  duration: number,</span><br><span class="line">  easing: Function,</span><br><span class="line">  from: number,</span><br><span class="line">  to: number,</span><br><span class="line">  unit: string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>This object can describe what to be change (<code>target</code>, <code>property</code>), how long it will last (<code>duration</code>), how does the chnage looks like (<code>easing</code>), and the start and end value (<code>from</code>, <code>to</code> and <code>unit</code>).</p><p>An animation object group list of tweens and play the real animation by add it self to the engine and step the tween.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animation</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (tweens) &#123;</span><br><span class="line">    <span class="keyword">this</span>.tweens</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  step (now) &#123;</span><br><span class="line">    <span class="keyword">let</span> elapsed = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.startTime) &#123;</span><br><span class="line">       <span class="keyword">this</span>.startTime = now</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> elapsed = now - <span class="keyword">this</span>.startTime</span><br><span class="line">    finisheds = <span class="keyword">this</span>.tweens.map(<span class="function">(<span class="params">tween</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> process = <span class="built_in">Math</span>.min(<span class="number">1</span>, elapsed / tween.duration)</span><br><span class="line">      <span class="keyword">const</span> eased = tween.easing(process)</span><br><span class="line">      <span class="keyword">const</span> value = tween.from + (tween.to - tween.from) * eased</span><br><span class="line">      tween.target.style[tween.property] = value + tween.unit</span><br><span class="line">      <span class="keyword">if</span> (process &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (finisheds.every(<span class="function">(<span class="params">f</span>) =&gt;</span> f)) &#123;</span><br><span class="line">       <span class="keyword">this</span>.pause()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  play () &#123;</span><br><span class="line">    engine.add(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  pause () &#123;</span><br><span class="line">    engine.remove(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  restart () &#123;</span><br><span class="line">    <span class="keyword">this</span>.pause()</span><br><span class="line">    <span class="keyword">this</span>.startTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">this</span>.play()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="the-libraries">The Libraries</span></h2><p>Now we have <code>engine</code>, <code>tween</code> and <code>Animtaion</code>. Use those object or class you can build some style animatons you what to. But it’s not enough, we need construct the <code>tweens</code> ourself and we only support css style property animation.<br>There are some realy awesome animation libraries exist:</p><ul><li><a href="https://github.com/juliangarnier/anime" target="_blank" rel="noopener">anime.js</a>: This is what inspire our little animation <code>engine</code> with   more features like <code>transform, svg and object property</code> (we can do it by add a <code>type</code> field to our <code>tween</code> and add the corresponding changes code to  <code>Animation.step</code> function), <code>timeline</code>, <code>can automaticlly transform params to tweens</code> etc.</li><li><a href="http://velocityjs.org" target="_blank" rel="noopener">velocityjs</a>: It’s incredibly fast, and it features color animation, transforms, loops, easings, SVG support, and scrolling.</li><li><a href="https://github.com/drcmda/react-spring" target="_blank" rel="noopener">react-spring</a>: data driven animation library.</li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API" target="_blank" rel="noopener">Web Animations API</a>: The W3C</li></ul><h2><span id="others">Others</span></h2><h3><span id="unit-transfrom">Unit transfrom</span></h3><ol><li><a href="https://github.com/jquery/jquery/blob/master/src/css/adjustCSS.js" target="_blank" rel="noopener">jquery.adjustCSS</a>: calculate the scale between current unit and the excepted unit, then apply the new united value.</li><li>velocityjs: <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fromUnit !== toUnit) &#123;</span><br><span class="line">  currentValue = <span class="string">`calc(<span class="subst">$&#123;<span class="keyword">from</span> * (<span class="number">1</span> - eased) + fromUnit&#125;</span> + <span class="subst">$&#123;to * eased + toUnit&#125;</span>)`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3><span id="flip-technique">FLIP Technique</span></h3><p>For list reordering stuff.<br><a href="https://aerotwist.com/blog/flip-your-animations/#the-general-approach" target="_blank" rel="noopener">https://aerotwist.com/blog/flip-your-animations/#the-general-approach</a></p><blockquote><ul><li>Calculate the <em>First</em> position.</li><li>Calculate the <em>Last</em> position.</li><li><em>Invert</em> the positions</li><li><em>Play</em> the animation</li></ul></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;The-engine&quot;&gt;&lt;a href=&quot;#The-engine&quot; class=&quot;headerlink&quot; title=&quot;The engine&quot;&gt;&lt;/a&gt;The engine&lt;/h2&gt;&lt;p&gt;We need a mechanism to deal with &lt;a href=&quot;https://github.com/wangbinyq/writings/wiki/Html-Reflow-and-Layout-Thrashing&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;layout thrashing&lt;/a&gt;. So we have an engine that group all animations into to a &lt;code&gt;requestAnimationFrame&lt;/code&gt; callback.&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>DNS 解析详解</title>
    <link href="https://wangbinyq.github.io/2018/02/28/dns/"/>
    <id>https://wangbinyq.github.io/2018/02/28/dns/</id>
    <published>2018-02-28T08:36:20.000Z</published>
    <updated>2018-11-22T08:27:11.355Z</updated>
    
    <content type="html"><![CDATA[<p>大家都知道 DNS (Domain Name System, 域名系统), 是一个域名和 IP 地址映射系统. 通过 DNS 我们可以根据比较容易记住的域名而不是数字 IP 地址来访问网络资源.<br>本文主要使用 <code>dig</code> (ubuntu 上可以通过 <code>sudo apt install dnsutils</code> 安装) 工具来了解 DNS 的各方面.<br><a id="more"></a></p><h2><span id="0x01-cname-和-a-记录">0x01 CNAME 和 A 记录</span></h2><p>在 DNS 中, A 记录值表示的是真正的 IP 地址, 而 CNAME 相当于域名的别名.<br>我们来看一个例子, 新浪的 DNS 解析:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> dig www.sina.com.cn</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 45272</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.sina.com.cn.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.sina.com.cn.0INCNAMEspool.grid.sinaedge.com.</span><br><span class="line">spool.grid.sinaedge.com. 280INA222.73.28.96</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:37:11 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 97</span><br></pre></td></tr></table></figure><p>其中 <code>QUESTION SECTION:</code> 表示我们要查找的是 <code>www.sina.com.cn</code> 的 A 记录, <code>ANSWER SECTION:</code> 返回了记录的结果.<br>这个查询返回了三条记录, 每条记录有五个字段分别代表了: 主机域名, TTL, 类型(IN 表示 Internet), DNS 记录类型以及记录值. DNS 记录类型如下图所示 (图片来自阿里云截图):</p><p><img src="/images/dns/dns record.png" alt="dns record"></p><p><code>www.sina.com.cn</code> 有一个 CNAME和一个 A记录. 如果我们直接在浏览器中访问 CNAME 值或者 IP 地址, 会发现不能访问.</p><p><img src="/images/dns/error.png" alt="error"></p><p>这是因为新浪服务器拒绝了非 <code>www.sina.com.cn</code> 域名访问. 我们可以构造一个 HTTP header 来实现直接连接 IP 访问新浪:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl 222.73.28.96 -H "Host: www.sina.com.cn"</span><br></pre></td></tr></table></figure></p><p>这样就能返回正常的页面.</p><h2><span id="0x02-另一个例子">0x02 另一个例子</span></h2><p>再来看一个例子:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ dig baidu.com                    </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; baidu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 23153</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;baidu.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">baidu.com.300INA111.13.101.208</span><br><span class="line">baidu.com.300INA123.125.114.144</span><br><span class="line">baidu.com.300INA220.181.57.216</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:53:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 86</span><br></pre></td></tr></table></figure><p>我们看到 <code>baidu.com</code> 返回了三个 A 记录地址. 那客户端应该选择哪一个作为服务器的 IP 地址呢?<br>这个需要看客户端的实现, 比如使用 <code>gethostbyname</code> 的话会选择一个 IP 地址返回,  <code>getaddrinfo</code> 会返回所有的地址.</p><h2><span id="0x03-ns-记录">0x03 NS 记录</span></h2><p>NS 记录是域名服务器记录，用来指定域名由哪个DNS服务器来进行解析.</p><p><code>dig</code> 可以添加 <code>+trace</code> 参数来获取完整 DNS 解析过程. 还是通过 <code>www.sina.com.cn</code> 作为例子.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> dig www.sina.com.cn +trace</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn +trace</span><br><span class="line">;; global options: +cmd</span><br><span class="line">.3600INNSd.root-servers.net.</span><br><span class="line">.3600INNSe.root-servers.net.</span><br><span class="line">.3600INNSf.root-servers.net.</span><br><span class="line">.3600INNSg.root-servers.net.</span><br><span class="line">.3600INNSh.root-servers.net.</span><br><span class="line">.3600INNSi.root-servers.net.</span><br><span class="line">.3600INNSj.root-servers.net.</span><br><span class="line">.3600INNSk.root-servers.net.</span><br><span class="line">.3600INNSl.root-servers.net.</span><br><span class="line">.3600INNSm.root-servers.net.</span><br><span class="line">.3600INNSa.root-servers.net.</span><br><span class="line">.3600INNSb.root-servers.net.</span><br><span class="line">.3600INNSc.root-servers.net.</span><br><span class="line">;; Received 1771 bytes from 192.168.1.6#53(192.168.1.6) in 0 ms</span><br><span class="line"></span><br><span class="line">cn.172800INNSb.dns.cn.</span><br><span class="line">cn.172800INNSns.cernet.net.</span><br><span class="line">cn.172800INNSc.dns.cn.</span><br><span class="line">cn.172800INNSd.dns.cn.</span><br><span class="line">cn.172800INNSa.dns.cn.</span><br><span class="line">cn.172800INNSg.dns.cn.</span><br><span class="line">cn.172800INNSf.dns.cn.</span><br><span class="line">cn.172800INNSe.dns.cn.</span><br><span class="line">cn.86400INDS41470 8 2 3623FB6E3B1F69C6855DA1E48D3A38236DD2EDF0380FB018FF538650 EAC2C4DD</span><br><span class="line">cn.86400INDS57724 8 2 5D0423633EB24A499BE78AA22D1C0C9BA36218FF49FD95A4CDF1A4AD 97C67044</span><br><span class="line">cn.86400INRRSIGDS 8 1 86400 20180313050000 20180228040000 41824 . GbRg9UYKus5nqvJxCKVZTaX5j2WYaF2c3jH5XOEPzqgcGp23+U941ZHz nKAXTv8oJq2+dJiRuVnwAD7c+Ge8MBJbd+tpw0jcQ3zs3SiocVhWgF3/ Bjig8ouJsuKukEuF89tx+oqbYjRrau9PFNJBoN2zlVZP1JQYTukYaGeY aK91OtgRuC1yVVQqNstLhU+YWyi7gNKOd31SMSpyvUZDIf+8wQrR6j9y dUb7zex8dk+XFS9/NqOXi6kRQxOPdflXXGieNZRVAnHfKdgO3LsXYmsD 92CY9G7cwj9XShFdYq7GLSirh3c9LvUR4E0VKk6qcr3usgKbmDPumyAv aN+ZwA==</span><br><span class="line">;; Received 754 bytes from 192.33.4.12#53(c.root-servers.net) in 173 ms</span><br><span class="line"></span><br><span class="line">sina.com.cn.86400INNSns3.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns2.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns1.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns4.sina.com.cn.</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN NSEC31 1 10 AEF123AB HIO2MHL5BSKBHFFRA5I1J58SU91CDLLA NS SOA RRSIG DNSKEY NSEC3PARAM</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN RRSIGNSEC3 8 3 21600 20180318092826 20180216084403 48018 com.cn. iuUIwe/vd4QLsTo8behQVf8ZPWaU9JsP+gxrUHop+oybuZH+II+kvOBW wTfGHap/n3C7iSevN80Wa2eFeH0QBWif2A30+zfg9hCzVjEEUDulmc1a 4+ltDbv4UZVJpBPRU7n2AgW4UMK/q0vyWqV6oKwmIygj58fhrMkqcrpR CpU=</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN NSEC31 1 10 AEF123AB UQROTQK62NOIM5U43DMF7AMC8JJFRM7T NS DS RRSIG</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN RRSIGNSEC3 8 3 21600 20180311113832 20180209104700 48018 com.cn. I1zxGBgSFJfq5GCrwlukCCkWNeQRcJJu9ydX5OgoH0mdYwVVLGoB2y1D htn8lGc4MMfdbY+zTdlnvYvBHdtFSS2+2eq+ficKzzZQ2CVtDrFm91Eo 0MK+BavvLcE5pkRpIfpI9FIIMrlNaj9cOBwWNR2g1yXfSYWSr5NUFKQG voE=</span><br><span class="line">;; Received 679 bytes from 203.119.25.1#53(a.dns.cn) in 33 ms</span><br><span class="line"></span><br><span class="line">www.sina.com.cn.0INCNAMEspool.grid.sinaedge.com.</span><br><span class="line">;; Received 81 bytes from 61.172.201.254#53(ns2.sina.com.cn) in 5 ms</span><br></pre></td></tr></table></figure><p>我们最上面域名为 <code>.</code> (根域名) 的 NS 记录, 一共有 13 条, 代表了 13 台根域名服务器. 接下来是在根域名服务器上查询 <code>cn.</code> (实际中最后一个点去掉) 得到的 8 条 NS 记录, 代表了顶级域名服务器. 然后是顶级域名服务器查询 <code>sina.com.cn</code> 得到的 4 条 NS 记录, 代表了授权域名服务器, 最后授权 DNS 返回了 <code>www.sina.com.cn</code> 的 CNAME 记录.</p><div class="tip"><br>授权域名服务器: 我们知道计算机要上网的话, 必须要设置 DNS (除非只用 IP), 或者 ISP 自动分配 DNS. 这个 DNS 服务器是叫做 LocalDNS, 提供了缓存和递归查询服务. 如果查询一个域名在 LocalDNS 上已经有缓存了, LocalDNS 直接返回结果 (叫做非授权应答); 如果 LocalDNS 上没有这个域名的话, LocalDNS 就要对域名发起递归查找(类似 dig +trace 的过程), 就是从根域名 -&gt; 顶级域名 -&gt; 授权域名查找这个域名, 并将应答返回, 同时缓存应答(可以看出根域名, 顶级域名也是授权域名服务器). 一般宽带运行商和公共DNS服务提供的是 LocalDNS, 域名注册商提供的是授权DNS.<br></div><p>假如我在阿里云上注册了一个域名 (example.com), 其 NS 记录就是 dns14.hichina.com 和 dns13.hichina.com (万网的授权域名服务器), 我们还可以设置 NS 记录指向其他的授权域名服务器.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;大家都知道 DNS (Domain Name System, 域名系统), 是一个域名和 IP 地址映射系统. 通过 DNS 我们可以根据比较容易记住的域名而不是数字 IP 地址来访问网络资源.&lt;br&gt;本文主要使用 &lt;code&gt;dig&lt;/code&gt; (ubuntu 上可以通过 &lt;code&gt;sudo apt install dnsutils&lt;/code&gt; 安装) 工具来了解 DNS 的各方面.&lt;br&gt;
    
    </summary>
    
    
      <category term="Network" scheme="https://wangbinyq.github.io/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Guide</title>
    <link href="https://wangbinyq.github.io/2018/02/28/hexo-guide/"/>
    <id>https://wangbinyq.github.io/2018/02/28/hexo-guide/</id>
    <published>2018-02-28T08:06:20.000Z</published>
    <updated>2018-11-22T08:55:30.618Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><a id="more"></a><h2><span id="quick-start">Quick Start</span></h2><h3><span id="create-a-new-post">Create a new post</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3><span id="run-server">Run server</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3><span id="generate-static-files">Generate static files</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3><span id="deploy-to-remote-sites">Deploy to remote sites</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="hexo" scheme="https://wangbinyq.github.io/tags/hexo/"/>
    
  </entry>
  
</feed>
