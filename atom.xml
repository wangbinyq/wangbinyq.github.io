<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wangb&#39;s blog</title>
  
  
  <link href="https://wangbinyq.github.io/atom.xml" rel="self"/>
  
  <link href="https://wangbinyq.github.io/"/>
  <updated>2021-09-29T05:51:19.917Z</updated>
  <id>https://wangbinyq.github.io/</id>
  
  <author>
    <name>wangb</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Webpack 多页面配置</title>
    <link href="https://wangbinyq.github.io/webpack-multiple-pages/"/>
    <id>https://wangbinyq.github.io/webpack-multiple-pages/</id>
    <published>2021-09-29T12:22:16.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>本文将基于 <code>Webpack 5</code> 配置出一套多页面的前端开发工作流. 适用于传统的后端模板渲染情景. 示例代码请点击<a href="https://github.com/wangbinyq/webpack-multiple-pages-example">链接</a>.</p><span id="more"></span><h2><span id="基础配置">基础配置</span></h2><p>首先我们创建一个空文件夹, 然后创建一个基础的 <code>Node</code> 项目: <code>yarn init -y</code>. 添加 <code>Webpack</code> 依赖 <code>yarn add -D webpack webpack-cli</code>.</p><p>创建一个基本 <code>webpack.conf.js</code> 配置文件:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="添加多页面">添加多页面</span></h2><p>接下来我们添加多页面 <code>a.html</code> 和 <code>b.html</code> 在 <code>src</code> 中. 这里 <code>a.html</code> 是一个完成的 <code>html</code>, <code>b.html</code> 是一个 <code>html</code> 片段, 因为大多数后端模板有 <code>layout</code> 机制, 不需要每个模板文件都是完整的 <code>html</code>.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a&quot;</span>&gt;</span></span><br><span class="line">    This is a.html</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;b&quot;</span>&gt;</span></span><br><span class="line">  This is b.html</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后我们添加脚本和样式文件, 我们将使用 <code>TypeScript</code> 和 <code>Babel</code> 来编译成 <code>js</code> 文件, 使用 <code>sass</code> 编译 <code>css</code> 文件. 具体文件内容参考示例.</p><p>现在我们的文件依赖结构是</p><p><img src="/images/webpack-multiple-pages/inital-depend.png" alt="文件依赖"></p><h2><span id="build-多页面">Build 多页面</span></h2><p>接下来我们添加依赖</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D typescript babel-loader @babel/core @babel/preset-env @babel/preset-typescript sass sass-loader css-loader mini-css-extract-plugin html-webpack-plugin</span><br></pre></td></tr></table></figure><p>生成 <code>tsconfig.json</code> 文件:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn tsc --init</span><br></pre></td></tr></table></figure><p>修改 <code>webpack.config.js</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">&quot;mini-css-extract-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义了我们的页面和 chunks</span></span><br><span class="line"><span class="keyword">var</span> pages = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  <span class="comment">// 通过 ts 定义页面入口文件</span></span><br><span class="line">  <span class="attr">entry</span>: pages.reduce(<span class="function">(<span class="params">e, p</span>) =&gt;</span> (&#123;...e, [p]: <span class="string">`./src/<span class="subst">$&#123;p&#125;</span>.ts`</span>&#125;), &#123;&#125;),</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash:8].js&#x27;</span>,</span><br><span class="line">    <span class="attr">clean</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.[jt]sx?$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [</span><br><span class="line">              <span class="string">&quot;@babel/preset-typescript&quot;</span>,</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.s[ac]ss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: MiniCssExtractPlugin.loader,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">filename</span>: <span class="string">&#x27;[name].[chunkhash:8].css&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;sass-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// css 文件单独抽取出来, 参考 https://webpack.js.org/plugins/mini-css-extract-plugin/</span></span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;[name].[contenthash:8].css&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// 生成 html, 参考 https://github.com/jantimon/html-webpack-plugin</span></span><br><span class="line">    ...pages.map(<span class="function"><span class="params">p</span> =&gt;</span> <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      <span class="comment">// 不自动注入 chunks</span></span><br><span class="line">      <span class="attr">inject</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">`./src/<span class="subst">$&#123;p&#125;</span>.html`</span>,</span><br><span class="line">      <span class="comment">// 生成的 html 文件名</span></span><br><span class="line">      <span class="attr">filename</span>: <span class="string">`<span class="subst">$&#123;p&#125;</span>.html`</span>,</span><br><span class="line">      <span class="comment">// 引用入口文件定义的 chunks</span></span><br><span class="line">      <span class="attr">chunks</span>: [p]</span><br><span class="line">    &#125;))</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;tsx&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 自动进行代码分割, 参考 https://webpack.js.org/plugins/split-chunks-plugin/</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们执行 <code>yarn webpack</code>, 可以发现在 <code>dist</code> 文件下有以下这些文件:</p><p><img src="/images/webpack-multiple-pages/webpack-1.png" alt="文件生成"></p><p>查看 <code>a.html</code>, 发现它并没有引用我们希望的 <code>a.xxxxx.js</code> 和 <code>a.xxxxx.css</code>, 这是因为我们设置了 <code>inject: false</code>, 不让 <code>webpack</code> 自动注入, 我们希望手动注入这些脚本和样式文件:</p><p>通过</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  &lt;%= htmlWebpackPlugin.tags.headTags %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;a&quot;</span>&gt;</span></span><br><span class="line">    This is a.html</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= htmlWebpackPlugin.tags.headTags %&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;b&quot;</span>&gt;</span></span><br><span class="line">  This is b.html</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>再次执行 <code>yarn webpack</code>, 可以看到生成的 <code>dist/a.html</code> 文件 <code>head</code> 部分已经包含了我们脚本和样式文件.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;本文将基于 &lt;code&gt;Webpack 5&lt;/code&gt; 配置出一套多页面的前端开发工作流. 适用于传统的后端模板渲染情景. 示例代码请点击&lt;a href=&quot;https://github.com/wangbinyq/webpack-multiple-pages-example&quot;&gt;链接&lt;/a&gt;.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Webpack" scheme="https://wangbinyq.github.io/tags/Webpack/"/>
    
    <category term="多页面" scheme="https://wangbinyq.github.io/tags/%E5%A4%9A%E9%A1%B5%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>C# 获取运行时内存占用</title>
    <link href="https://wangbinyq.github.io/csharp-runtime-memory-usage/"/>
    <id>https://wangbinyq.github.io/csharp-runtime-memory-usage/</id>
    <published>2021-09-28T06:22:18.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="获取-gc-分配的内存">获取 GC 分配的内存</span></h2><p>这里输出的是 <code>GC</code> 管理的堆上内存.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Console.WriteLine(&quot;Total Memory: &#123;0&#125;&quot;, GC.GetTotalMemory(false));</span><br></pre></td></tr></table></figure><span id="more"></span><h2><span id="获取进程分配的所有内存">获取进程分配的所有内存</span></h2><p>这里输出的是进程从操作系统申请的所有内存, 包括堆, 栈, 静态变量, 本地库申请的内存等, .</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Process proc = Process.GetCurrentProcess();</span><br><span class="line">System.Console.WriteLine($&quot;Current Memory Usage: &#123;proc.PrivateMemorySize64&#125;&quot;);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">C# 获取运行时内存占用</summary>
    
    
    
    <category term="C#" scheme="https://wangbinyq.github.io/categories/C/"/>
    
    
    <category term="C#" scheme="https://wangbinyq.github.io/tags/C/"/>
    
    <category term="内存占用" scheme="https://wangbinyq.github.io/tags/%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>VSCode 中启用内部库代码调试</title>
    <link href="https://wangbinyq.github.io/vscode-justmycode/"/>
    <id>https://wangbinyq.github.io/vscode-justmycode/</id>
    <published>2021-09-26T00:48:37.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>但我们使用 VSCode 按 F5 调试代码时, 默认的设置只会加载我们自己的代码, 跳过加载库中符号. 如果需要步进到库中的代码, 我们需要修改 <code>lanuch.json</code>, 在 <code>configurations</code> 第一项中添加 <code>&quot;justMyCode&quot;: false</code>.</p><span id="more"></span>]]></content>
    
    
    <summary type="html">&lt;p&gt;但我们使用 VSCode 按 F5 调试代码时, 默认的设置只会加载我们自己的代码, 跳过加载库中符号. 如果需要步进到库中的代码, 我们需要修改 &lt;code&gt;lanuch.json&lt;/code&gt;, 在 &lt;code&gt;configurations&lt;/code&gt; 第一项中添加 &lt;code&gt;&amp;quot;justMyCode&amp;quot;: false&lt;/code&gt;.&lt;/p&gt;</summary>
    
    
    
    <category term="VSCode" scheme="https://wangbinyq.github.io/categories/VSCode/"/>
    
    
    <category term="VSCode" scheme="https://wangbinyq.github.io/tags/VSCode/"/>
    
    <category term="调试" scheme="https://wangbinyq.github.io/tags/%E8%B0%83%E8%AF%95/"/>
    
    <category term="库代码" scheme="https://wangbinyq.github.io/tags/%E5%BA%93%E4%BB%A3%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET 中 AddTransient AddScoped AddSingleton 的区别</title>
    <link href="https://wangbinyq.github.io/addtransient-addscoped-addsingleton/"/>
    <id>https://wangbinyq.github.io/addtransient-addscoped-addsingleton/</id>
    <published>2021-09-24T10:40:15.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>在 <code>.NET</code> 中依赖注入有三种生命周期:</p><ul><li><code>Singleton</code> 在程序运行时只创建一个对象实例. 它会在第一次使用该对象时创建, 之后的所有请求获取的都是同一个对象. 由于单例是全局存在的, 如果这种 <code>Service</code> 里面发生了内存泄漏, 会影响到整个程序.</li><li><code>Scoped</code> 我们称 <code>ASP.NET</code> 每一个请求创建了一个 <code>scope</code>, 因此对于 <code>Scoped</code> 生命周期会在当前请求生效. 即每一个请求都会创建一个新的实例, 但是在一个请求中所有实例都相同. 适用于一个请求中保存状态.</li><li><code>Transient</code> 在每次获取实例时都创建一个新的实例. 所以它会占用比较多的内存和资源, 对性能产生影响. 只适合无状态的轻量级的 <code>Service</code>.</li></ul><span id="more"></span>]]></content>
    
    
    <summary type="html">ASP.NET 中 AddTransient AddScoped AddSingleton 的区别</summary>
    
    
    
    <category term="ASP.NET" scheme="https://wangbinyq.github.io/categories/ASP-NET/"/>
    
    
    <category term="ASP.NET" scheme="https://wangbinyq.github.io/tags/ASP-NET/"/>
    
    <category term="依赖注入" scheme="https://wangbinyq.github.io/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/"/>
    
    <category term="生命周期" scheme="https://wangbinyq.github.io/tags/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    
  </entry>
  
  <entry>
    <title>ASP.NET 中 MapControllerRoute, MapDefaultControllerRoute 和 MapControllers 的区别</title>
    <link href="https://wangbinyq.github.io/mapcontrollerroute-vs-mapdefaultcontrollerroute-mapcontrollers/"/>
    <id>https://wangbinyq.github.io/mapcontrollerroute-vs-mapdefaultcontrollerroute-mapcontrollers/</id>
    <published>2021-09-24T04:52:02.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p><code>MapControllerRoute</code> 定义了默认的 <code>Controller</code> 的路由映射关系, 就像我们在大部分的教程中看到的:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.MapControllerRoute(</span><br><span class="line">    name: &quot;default&quot;,</span><br><span class="line">    pattern: &quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;);</span><br></pre></td></tr></table></figure><p><code>MapDefaultControllerRoute</code> 是上面代码的缩写形式, 也就是 <code>pattern</code> 等于 <code>&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;</code>.</p><p><code>MapControllers</code> 没有定义默认的 <code>Controller</code> 的路由, 我们需要在 <code>Controller</code> 或 <code>Action</code> 上使用 <code>[Route]</code> 来定义对应的路由, 大部分时候在 <code>ApiController</code> 中使用.</p><span id="more"></span>]]></content>
    
    
    <summary type="html">ASP.NET 中 MapControllerRoute, MapDefaultControllerRoute 和 MapControllers 的区别</summary>
    
    
    
    <category term="ASP.NET" scheme="https://wangbinyq.github.io/categories/ASP-NET/"/>
    
    
    <category term="ASP.NET" scheme="https://wangbinyq.github.io/tags/ASP-NET/"/>
    
    <category term="路由" scheme="https://wangbinyq.github.io/tags/%E8%B7%AF%E7%94%B1/"/>
    
  </entry>
  
  <entry>
    <title>在 .NET 中运行后台任务</title>
    <link href="https://wangbinyq.github.io/net-background-task/"/>
    <id>https://wangbinyq.github.io/net-background-task/</id>
    <published>2021-09-24T01:36:50.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>在一个 <code>ASP.NET</code> 程序中我们常常需要进行比较耗时间的任务, 通常我们不会在一个请求中等待这些任务完成后再返回响应, 比如发邮件, 短信等. 这时候就需要我们将任务放到后台运行, 然后直接返回响应, 告诉用户任务已经再进行了. 本文将教会大家如何在 <code>.NET</code> 中运行后台任务, 示例代码请点击<a href="https://github.com/wangbinyq/net-background-task-example">链接</a></p><span id="more"></span><h2><span id="创建-worker-程序">创建 <code>Worker</code> 程序</span></h2><p><code>.NET</code> 自带了一个后台任务模板, 我们执行 <code>dotnet new worker -o BackgroundTask</code> 就可以创建一个通用的 <code>console</code> 后台任务程序. 该模板中包含一个 <code>Worker</code> 类型, 继承了 <code>BackgroundService</code>, 然后在 <code>HostBuilder</code> 中通过 <code>AddHostedService</code> 注册. 最后调用 <code>host.RunAsync()</code> 执行该后台任务. 该示例程序每隔一秒钟打印当前时间.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">namespace BackgroundTask;</span><br><span class="line"></span><br><span class="line">public class Worker : BackgroundService</span><br><span class="line">&#123;</span><br><span class="line">    private readonly ILogger&lt;Worker&gt; _logger;</span><br><span class="line"></span><br><span class="line">    public Worker(ILogger&lt;Worker&gt; logger)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override async Task ExecuteAsync(CancellationToken stoppingToken)</span><br><span class="line">    &#123;</span><br><span class="line">        while (!stoppingToken.IsCancellationRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(&quot;Worker running at: &#123;time&#125;&quot;, DateTimeOffset.Now);</span><br><span class="line">            await Task.Delay(1000, stoppingToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">using BackgroundTask;</span><br><span class="line"></span><br><span class="line">IHost host = Host.CreateDefaultBuilder(args)</span><br><span class="line">    .ConfigureServices(services =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        services.AddHostedService&lt;Worker&gt;();</span><br><span class="line">    &#125;)</span><br><span class="line">    .Build();</span><br><span class="line"></span><br><span class="line">await host.RunAsync();</span><br></pre></td></tr></table></figure><p><code>AddHostedService</code> 接受一个 <code>IHostedService</code> 的泛型参数, 其有两个方法 <code>StartAsync</code> 和 <code>StopAsync</code>. 一个 <code>IHostedService</code> 跟一个单例 <code>Service</code> 相似, 只是启动时会调用 <code>StartAsync</code> 方法, 结束时调用 <code>StopAsync</code> 方法.<br><code>BackgroundService</code> 实际上是一个 <code>IHostedService</code> 长时间运行的实现. </p><p>现在我们添加一个 <code>SimpleWorker</code> 类:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">namespace BackgroundTask;</span><br><span class="line"></span><br><span class="line">public class SimpleWorker : IHostedService</span><br><span class="line">&#123;</span><br><span class="line">    private ILogger&lt;SimpleWorker&gt; _logger;</span><br><span class="line"></span><br><span class="line">    public SimpleWorker(ILogger&lt;SimpleWorker&gt; logger)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Task StartAsync(CancellationToken cancellationToken)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;Simple Worker Start&quot;);</span><br><span class="line">        return Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Task StopAsync(CancellationToken cancellationToken)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;Simple Worker Stop&quot;);</span><br><span class="line">        return Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们还需要在 <code>Program.cs</code> 中添加注册.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services.AddHostedService&lt;SimpleWorker&gt;();</span><br></pre></td></tr></table></figure><p>现在在启动和结束时会分别打印信息.</p><p><img src="/images/background-task/task-1.png" alt="打印信息"></p><h2><span id="使用-timer-进行定时任务">使用 <code>Timer</code> 进行定时任务</span></h2><p>默认的 <code>Worker</code> 实现定时每秒钟打印执行的效果, 我们也可以使用 <code>Timer</code> 可以获得同样的效果.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">namespace BackgroundTask;</span><br><span class="line"></span><br><span class="line">public class TimerWorker : IHostedService</span><br><span class="line">&#123;</span><br><span class="line">    private int _count = 0;</span><br><span class="line">    private ILogger&lt;TimerWorker&gt; _logger;</span><br><span class="line">    private Timer? _timer;</span><br><span class="line"></span><br><span class="line">    public TimerWorker(ILogger&lt;TimerWorker&gt; logger)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Task StartAsync(CancellationToken cancellationToken)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;Timer Worker Start&quot;);</span><br><span class="line">        _timer = new Timer(DoWork, null, TimeSpan.Zero, TimeSpan.FromSeconds(5));</span><br><span class="line"></span><br><span class="line">        return Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Task StopAsync(CancellationToken cancellationToken)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(&quot;Timer Worker Stop&quot;);</span><br><span class="line"></span><br><span class="line">        return Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void DoWork(object? state)</span><br><span class="line">    &#123;</span><br><span class="line">        var count = Interlocked.Increment(ref _count);</span><br><span class="line"></span><br><span class="line">        _logger.LogInformation($&quot;count = &#123;count&#125;, time: &#123;DateTimeOffset.Now&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时别忘了注册该 <code>Service</code>.</p><p><img src="/images/background-task/task-2.png" alt="定时任务"></p><h2><span id="使用-channel-创建任务队列">使用 <code>Channel</code> 创建任务队列</span></h2><p>更常见的使用后台任务的方式是使用队列, <code>.NET</code> 为我们提供了 <code>System.Threading.Channel</code> 类. 这里我们需要两个 <code>Worker</code>: 一个作为生产者, 一个作为消费者:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">namespace BackgroundTask;</span><br><span class="line"></span><br><span class="line">using System.Threading.Channels;</span><br><span class="line"></span><br><span class="line">public class ProducerWorker : BackgroundService</span><br><span class="line">&#123;</span><br><span class="line">    private int _count = 0;</span><br><span class="line">    private Channel&lt;int&gt; _queue;</span><br><span class="line"></span><br><span class="line">    public ProducerWorker(Channel&lt;int&gt; queue)</span><br><span class="line">    &#123;</span><br><span class="line">        _queue = queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override async Task ExecuteAsync(CancellationToken stoppingToken)</span><br><span class="line">    &#123;</span><br><span class="line">        while (!stoppingToken.IsCancellationRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            var count = Interlocked.Increment(ref _count);</span><br><span class="line">            await _queue.Writer.WriteAsync(count, stoppingToken);</span><br><span class="line">            await Task.Delay(1000, stoppingToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">namespace BackgroundTask;</span><br><span class="line"></span><br><span class="line">using System.Threading;</span><br><span class="line">using System.Threading.Channels;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">public class ConsumerWorker : BackgroundService</span><br><span class="line">&#123;</span><br><span class="line">    private Channel&lt;int&gt; _queue;</span><br><span class="line">    private ILogger&lt;ConsumerWorker&gt; _logger;</span><br><span class="line"></span><br><span class="line">    public ConsumerWorker(Channel&lt;int&gt; queue, ILogger&lt;ConsumerWorker&gt; logger)</span><br><span class="line">    &#123;</span><br><span class="line">        _queue = queue;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override async Task ExecuteAsync(CancellationToken stoppingToken)</span><br><span class="line">    &#123;</span><br><span class="line">        while (!stoppingToken.IsCancellationRequested)</span><br><span class="line">        &#123;</span><br><span class="line">            var count = await _queue.Reader.ReadAsync(stoppingToken);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation($&quot;do work for: &#123;count&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时我们需要通过依赖注入注入一个 <code>Channel&lt;int&gt;</code> 的单例:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var queue = Channel.CreateBounded&lt;int&gt;(10);</span><br><span class="line">services.AddSingleton(queue);</span><br><span class="line">services.AddHostedService&lt;ProducerWorker&gt;();</span><br><span class="line">services.AddHostedService&lt;ConsumerWorker&gt;();</span><br></pre></td></tr></table></figure><p><img src="/images/background-task/task-3.png" alt="队列任务"></p>]]></content>
    
    
    <summary type="html">在 .NET 中运行后台任务</summary>
    
    
    
    <category term=".NET" scheme="https://wangbinyq.github.io/categories/NET/"/>
    
    <category term="ASP.NET" scheme="https://wangbinyq.github.io/categories/NET/ASP-NET/"/>
    
    
    <category term=".NET" scheme="https://wangbinyq.github.io/tags/NET/"/>
    
    <category term="后台任务" scheme="https://wangbinyq.github.io/tags/%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1/"/>
    
    <category term="定时任务" scheme="https://wangbinyq.github.io/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    
    <category term="队列任务" scheme="https://wangbinyq.github.io/tags/%E9%98%9F%E5%88%97%E4%BB%BB%E5%8A%A1/"/>
    
    <category term="Generic Host" scheme="https://wangbinyq.github.io/tags/Generic-Host/"/>
    
  </entry>
  
  <entry>
    <title>C# 中如何遍历 Enum 枚举值</title>
    <link href="https://wangbinyq.github.io/how-to-enumerate-enum-in-csharp/"/>
    <id>https://wangbinyq.github.io/how-to-enumerate-enum-in-csharp/</id>
    <published>2021-09-22T07:47:20.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>假如我们有如下 <code>Shape</code> 枚举类型, 我们要遍历其中所有的枚举值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public enum Shape</span><br><span class="line">&#123;</span><br><span class="line">    Circle,</span><br><span class="line">    Triangle,</span><br><span class="line">    Rect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以通过 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.enum.getvalues"><code>GetValues</code></a> 方法实现:</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var shapes = Enum.GetValues(typeof(Shape));</span><br><span class="line"></span><br><span class="line">foreach (var shape in shapes)</span><br><span class="line">&#123;</span><br><span class="line">    DoSomething(shape);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外我们还可以做一点封装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static class EnumUtil &#123;</span><br><span class="line">    public static IEnumerable&lt;T&gt; GetValues&lt;T&gt;() &#123;</span><br><span class="line">        return Enum.GetValues(typeof(T)).Cast&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var shapes = EnumUtil.GetValues&lt;Shape&gt;();</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">在 C# 中遍历 Enum 枚举值</summary>
    
    
    
    <category term="C# 语言" scheme="https://wangbinyq.github.io/categories/C-%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="C#" scheme="https://wangbinyq.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>C# 如何在字符串中查找大小写不敏感子字符串</title>
    <link href="https://wangbinyq.github.io/case-insensitive-containstring/"/>
    <id>https://wangbinyq.github.io/case-insensitive-containstring/</id>
    <published>2021-09-22T05:24:20.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>在 C# 中如何查找大小写不敏感的子字符串, 比如我们想要下面的例子返回 <code>true</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string title = &quot;ASTRINGTOTEST&quot;;</span><br><span class="line">title.Contains(&quot;string&quot;) == true;</span><br></pre></td></tr></table></figure><span id="more"></span><h2><span id="对于英语">对于英语</span></h2><p>一种解决方案是将两个字符串都转换成大写或小写, 然后再进行比较:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title.ToUpper().Contains(&quot;string&quot;.ToUpper()) == true;</span><br></pre></td></tr></table></figure><p>另一种方案是使用 <a href="https://msdn.microsoft.com/en-us/library/ms224425(v=vs.110).aspx"><code>IndexOf</code> 方法</a>, 该方法有一个重载方法可以忽略字符串的大小写, 即 <a href="https://msdn.microsoft.com/en-us/library/system.stringcomparer.ordinalignorecase(v=vs.110).aspx"><code>StringComparison.OrdinalIgnoreCase</code></a> 作为第二个参数:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string title = &quot;STRING&quot;;</span><br><span class="line">bool contains = title.IndexOf(&quot;string&quot;, StringComparison.OrdinalIgnoreCase) &gt;= 0;</span><br></pre></td></tr></table></figure><p>我们还可以为 <code>String</code> 定义一个扩展方法, 重载 <code>Contains</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static class StringExtensions</span><br><span class="line">&#123;</span><br><span class="line">    public static bool Contains(this string source, string toCheck, StringComparison comp)</span><br><span class="line">    &#123;</span><br><span class="line">        return source?.IndexOf(toCheck, comp) &gt;= 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用方法:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string title = &quot;STRING&quot;;</span><br><span class="line">bool contains = title.Contains(&quot;string&quot;, StringComparison.OrdinalIgnoreCase);</span><br></pre></td></tr></table></figure><h2><span id="非英语语言解决方案">非英语语言解决方案</span></h2><p>不同语言对于大小写的定义是不一样的, 比如在英语中 <code>I</code> 和 <code>i</code> 是第九个字符的大小写形式, 然而在土耳其语中, 这两个字符分别是<a href="http://en.wikipedia.org/wiki/Dotted_and_dotless_I">第 19 和 20 个字符</a>, 土耳其语中 <code>i</code> 的大写形式为 <code>İ</code>. 因此 <code>tin</code> 和 <code>TIN</code> 在英语中是同一个单词, 在土耳其语中前一个词表示 <code>精神</code>, 第二个是一个拟声词.</p><p>因此上面提供的方法只适用于英语语言, 为了兼容各种不同语言, C# 中提供了 <a href="http://msdn.microsoft.com/en-gb/library/system.globalization.cultureinfo(v=vs.110).aspx"><code>CultureInfo</code></a> API, 我们可以通过下面方法进行判断:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">culture.CompareInfo.IndexOf(paragraph, word, CompareOptions.IgnoreCase) &gt;= 0</span><br></pre></td></tr></table></figure><p>其中 <code>culture</code> 是一个 <code>CultureInfo</code> 对象.</p>]]></content>
    
    
    <summary type="html">在 C# 中如何查找大小写不敏感的子字符串</summary>
    
    
    
    <category term="C# 语言" scheme="https://wangbinyq.github.io/categories/C-%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="C#" scheme="https://wangbinyq.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>C# 语言 String 和 string 的区别</title>
    <link href="https://wangbinyq.github.io/csharp-string-difference/"/>
    <id>https://wangbinyq.github.io/csharp-string-difference/</id>
    <published>2021-09-22T05:24:20.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>在 C# 语言中 <code>string</code> 是 <code>System.String</code> 的别名. 因此从技术上来说, 这两者没有任何区别, 就像 <code>int</code> 和 <code>System.Int32</code>.</p><span id="more"></span><p>通常我们推荐使用 <code>string</code> 类型声明一个对象.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string place = &quot;world&quot;;</span><br></pre></td></tr></table></figure><p>同时, 推荐使用 <code>String</code> 来引用字符串类型中的方法, 属性等, 比如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string greet = String.Format(&quot;Hello &#123;0&#125;!&quot;, place);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">C# 中 String 和 string 类型的区别和适合的使用方式</summary>
    
    
    
    <category term="C# 语言" scheme="https://wangbinyq.github.io/categories/C-%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="C#" scheme="https://wangbinyq.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>理解 Angular 依赖注入</title>
    <link href="https://wangbinyq.github.io/ng-di/"/>
    <id>https://wangbinyq.github.io/ng-di/</id>
    <published>2018-11-22T16:54:00.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p><code>Angular</code> 程序开发中 <code>Provider</code> 和依赖注入是两个非常重要的概念, 关系到我们如何编写程序. 本文将解释 <code>@Inject()</code>, <code>@Injectable()</code> 两个装饰器背后的原理和它们的使用场景, 以及 <code>Angular</code> 依赖注入框架中的 <code>token</code>, <code>provider</code> 和 <code>Angular</code> 是如何创建依赖的.</p><span id="more"></span><h2><span id="注入-providers">注入 providers</span></h2><p><code>Angular</code> 的依赖注入背后有很多魔法发生. <code>Angular 1.x</code> 时代我们可以通过字符串 token 来获取指定的依赖.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SomeController</span>(<span class="params">$scope</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// use $scope</span></span><br><span class="line">&#125;</span><br><span class="line">SomeController.$inject = [<span class="string">&#x27;$scope&#x27;</span>]</span><br></pre></td></tr></table></figure><p>你可以通过之前的<a href="https://toddmotto.com/angular-js-dependency-injection-annotation-process/">文章</a>来获取更多信息.</p><p>虽然这种方式曾经很好, 但是也存在一些缺陷. 通常我们会通过创建各种模块 (<code>Module</code>) 和引用其他模块 (比如 <code>ui-router</code>) 来构建我们的程序. 不同的模块中的 controllers/services 不能用相同的名字, 否则就会发成冲突.</p><p>幸运的是,新的  <code>Angular</code> 重写了依赖注入系统, 使其更强大更灵活.</p><h3><span id="新的依赖注入系统">新的依赖注入系统</span></h3><p>当需要注入服务 (<code>provider</code>) 到组件或其他服务中时, 我们在构造函数中指定需要注入的类型. 比如:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;exmaple-component&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;I am a component&lt;/div&gt;&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> http: Http</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入的类型标记为 <code>Http</code>, <code>Angular</code> 能自动将其赋值给 <code>http</code>.</p><p>这看起来非常的神奇. 类型标记只在 <code>TypeScript</code> 中存在, 当程序转译成 <code>JavaScript</code> 并在浏览器中运行时, 我们对 <code>http</code> 参数毫无所知 (在运行时 <code>http</code> 可以为任何对象).</p><p>我们需要将 <code>tsconfig.json</code> 中的 <code>emitDecoratorMetadata</code> 设成 <code>true</code>. 这样在转译后的 <code>JavaScript</code> 的代码中, 会将参数类型加到装饰器上.</p><p>我们来看转译后的 <code>JavaScript</code> 代码 (ES6):</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ExampleComponent = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ExampleComponent</span>(<span class="params">http</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.http = http;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ExampleComponent;</span><br><span class="line">&#125;)();</span><br><span class="line">ExampleComponent = __decorate(</span><br><span class="line">  [</span><br><span class="line">    Component(&#123;</span><br><span class="line">      <span class="attr">selector</span>: <span class="string">&#x27;example-component&#x27;</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;I am a component&lt;/div&gt;&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    __metadata(<span class="string">&#x27;design:paramtypes&#x27;</span>, [Http]),</span><br><span class="line">  ],</span><br><span class="line">  ExampleComponent</span><br><span class="line">);<span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@Component(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;exmaple-component&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;I am a component&lt;/div&gt;&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">private http: Http</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们能看到转译后的代码中 <code>http</code> 对应上了 <code>@angualr/http</code> 中的 <code>Http</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__metadata(<span class="string">&#x27;design:paramtypes&#x27;</span>, [Http]);</span><br></pre></td></tr></table></figure><p>最终 <code>@Component</code> 装饰器转译成了 ES 代码, 并通过 <code>__decorate</code> 附加了一些元信息 <code>metadata</code>. 这些信息能告诉 <code>Angular</code> 要将 <code>Http</code> 传递给组件的构造函数, 并最终赋值给 <code>this.http</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExampleComponent</span>(<span class="params">http</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.http = http;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>metadata</code> 实现了 <code>$inject</code> 中功能, 但是这里作为 <code>token</code> 的是类而不是字符串. 命名冲突就不会发生了.</p><div class="tip">你可能已经听过 token (或者 OpaqueToken) 的概念. Angular 使用 token 来存储或获取 providers. Token 作为 key 来引用 (hash?) provider. 不同于传统的 key, token 可以是任何值作为 key (对象, 字符串, 类等).<div><h3><span id="inject"><code>@Inject()</code></span></h3><p>所以 <code>@Inject</code> 起什么作用呢? 我们将组件改写成:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Inject &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;example-component&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;I am a component&lt;/div&gt;&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(Http) <span class="keyword">private</span> http</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// use `this.http` which is the Http provider</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这一次, 我们通过 <code>@Inject</code> 手动提供 <code>token</code>.</p><p>如果组件或服务需要很多依赖, 这样写会非常的麻烦. <code>Angular</code> 可以通过 <code>metadata</code> 自动找到依赖, 所有大多数情况下我们都不需要使用 <code>@Inject</code>.</p><p>唯一需要 <code>@Inject</code> 的情况是在同时使用 <code>OpaqueToken</code> 对象时.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myToken = <span class="keyword">new</span> OpaqueToken(<span class="string">&#x27;myValue&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(...)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> token: myToken</span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里 <code>myToken</code> 不是类型, 而是值. 这意味着上面的代码会报错. 但是使用 <code>@Inject</code> 的话就可以了:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myToken = <span class="keyword">new</span> OpaqueToken(<span class="string">&#x27;myValue&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(...)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(myToken) <span class="keyword">private</span> token</span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在不会深入 <code>OpaqueToken</code>, 但是上面的例子足够表明 <code>@Inject</code> 的作用.</p><h3><span id="injectable"><code>@Injectable()</code></span></h3><p>我们并不需要在所有的类上添加 <code>@Injectable</code> 装饰器, 才可以将其注入到组件或服务中. 虽然可能会发生变化, 有一个 <a href="https://github.com/angular/angular/issues/13820">issue</a> 讨论需要强制加上 <code>@Injectable</code> (4.0 已经变成强制需要 <code>@Injectable</code>)</p><p>当我们使用装饰器时, 将被装饰的类的元信息存储成能被 <code>Angular</code> 处理的格式, 这些元信息中就包含了这个类的依赖.</p><p>如果没有使用装饰器添加元信息, <code>Angular</code> 就无从得知类的依赖. 这就是我们为什么需要 <code>@Injectable()</code>. <code>@Injectable()</code> 并没有其他的功能, 仅仅是提供了一些元信息.</p><h2><span id="token-和依赖注入">Token 和依赖注入</span></h2><p>现在我们知道了如何告诉 <code>Angular</code> 需要注入的内容, 现在我们来学习 <code>Angular</code> 如何知道从哪获取依赖以及如何实例化他们.</p><h3><span id="注册-provide">注册 provide</span></h3><p>我们先来看如何注册一个服务到一个 <code>NgModule</code> 上.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>上面例子是下面的简化版:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [&#123;</span><br><span class="line">    <span class="attr">provide</span>: AuthService,</span><br><span class="line">    <span class="attr">useClass</span>: AuthService</span><br><span class="line">  &#125;],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>provide</code> 字段表示我们注册的 provider 的 <code>token</code>. 当 <code>Angular</code> 看到 <code>AuthService</code> <code>token</code> 时, 就会取 <code>useClass</code> 的值进行实例化.</p><p>这样做有很多优点. 其一, 我们可以注册多个相同 <code>class</code> 的 <code>provide</code>, 而且不会发生冲突 (只要 <code>token</code> 不一样); 第二, 我们可以通过相同的 <code>token</code> 来覆盖之前的 <code>provide</code>.</p><h3><span id="覆盖-providers">覆盖 <code>providers</code></span></h3><p>我们的 <code>AuthService</code> 代码如下:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Http &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> http: Http</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  authenticateUser(username: <span class="built_in">string</span>, <span class="attr">password</span>: <span class="built_in">string</span>): Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// returns true or false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.http.post(<span class="string">&#x27;/api/auth&#x27;</span>, &#123; username, password &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getUsername(): Observable&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.http.post(<span class="string">&#x27;/api/user&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设我们的程序中使用了这个服务, 例如登录:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;auth-login&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;button (click)=&quot;login()&quot;&gt;</span></span><br><span class="line"><span class="string">      Login</span></span><br><span class="line"><span class="string">    &lt;/button&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> authService: AuthService</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">login</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.authService</span><br><span class="line">      .authenticateUser(<span class="string">&#x27;toddmotto&#x27;</span>, <span class="string">&#x27;straightouttacompton&#x27;</span>)</span><br><span class="line">      .subscribe(<span class="function">(<span class="params">status: <span class="built_in">boolean</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// do something if the user has logged in</span></span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>显示用户名:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;user-info&#x27;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      You are &#123;&#123; username &#125;&#125;!</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> authService: AuthService</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">ngOnInit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.authService</span><br><span class="line">      .getUsername()</span><br><span class="line">      .subscribe(<span class="function">(<span class="params">username: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">this</span>.username = username);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将上面所有代码整合成一个模块, 比如 <code>AuthModule</code>:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;./login.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserInfoComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;./user-info.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [LoginComponent, UserInfoComponent],</span><br><span class="line">  <span class="attr">providers</span>: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>其他的组件可能也会依赖 <code>AuthService</code>. 现在假设我们有一个新的需求, 需要修改授权方法使得用户可以通过 Facebook 登录.</p><p>一种方法是修改所有的组件, 将其构造函数中的 <code>AuthService</code> 替换成新的服务. 另外我们也可以通过修改 <code>providers</code> 来将 <code>AuthService</code> 覆盖成 <code>FacebookAuthService</code>:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// totally made up</span></span><br><span class="line"><span class="keyword">import</span> &#123; FacebookAuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;@facebook/angular&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth.service&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; LoginComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;./login.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserInfoComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;./user-info.component&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [LoginComponent, UserInfoComponent],</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: AuthService,</span><br><span class="line">      <span class="attr">useClass</span>: FacebookAuthService,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>这里我们没有采用简写方法, 并且替换了 <code>useClass</code> 的值. 这样在模块中的 <code>AuthService</code> <code>token</code> 就会使用 <code>FacebookAuthService</code> 类.</p><h2><span id="理解注入器-injector">理解注入器 (Injector)</span></h2><p>翻译略 (一些 AOT 源码的解释, 有兴趣的可以研究下).</p><h2><span id="参考资料">参考资料</span></h2><ul><li><a href="http://blog.wolksoftware.com/decorators-reflection-javascript-typescript">装饰器反射相关4篇</a></li></ul></div></div>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;code&gt;Angular&lt;/code&gt; 程序开发中 &lt;code&gt;Provider&lt;/code&gt; 和依赖注入是两个非常重要的概念, 关系到我们如何编写程序. 本文将解释 &lt;code&gt;@Inject()&lt;/code&gt;, &lt;code&gt;@Injectable()&lt;/code&gt; 两个装饰器背后的原理和它们的使用场景, 以及 &lt;code&gt;Angular&lt;/code&gt; 依赖注入框架中的 &lt;code&gt;token&lt;/code&gt;, &lt;code&gt;provider&lt;/code&gt; 和 &lt;code&gt;Angular&lt;/code&gt; 是如何创建依赖的.&lt;/p&gt;</summary>
    
    
    
    
    <category term="angular frontend di" scheme="https://wangbinyq.github.io/tags/angular-frontend-di/"/>
    
  </entry>
  
  <entry>
    <title>how to write an anime library</title>
    <link href="https://wangbinyq.github.io/how-to-write-an-anime-library/"/>
    <id>https://wangbinyq.github.io/how-to-write-an-anime-library/</id>
    <published>2018-04-17T13:42:11.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<h2><span id="the-engine">The engine</span></h2><p>We need a mechanism to deal with <a href="https://github.com/wangbinyq/writings/wiki/Html-Reflow-and-Layout-Thrashing">layout thrashing</a>. So we have an engine that group all animations into to a <code>requestAnimationFrame</code> callback.</p><span id="more"></span><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> engine = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> animations = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> raf = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">play</span> (<span class="params"></span>) </span>&#123; raf = requestAnimationFrame(step) &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">step</span> (<span class="params"></span>) </span>&#123; animations.forEach(<span class="function">(<span class="params">anim</span>) =&gt;</span> anim.step()); <span class="keyword">if</span> (animations.length) play() &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">anim</span>) </span>&#123; animations.push(anim) &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">remove</span> (<span class="params">anim</span>) </span>&#123; <span class="keyword">const</span> index = animations.indexOf(index); animations.splice(index, <span class="number">1</span>) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    play, step, add, remove, raf</span><br><span class="line">  &#125; </span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h2><span id="the-tween-and-animation">The tween and animation</span></h2><p>A tween object repersent a property change. It is an object like this:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const defaultTweenSetting = &#123;</span><br><span class="line">  target: Element,</span><br><span class="line">  property: string,</span><br><span class="line">  duration: number,</span><br><span class="line">  easing: Function,</span><br><span class="line">  from: number,</span><br><span class="line">  to: number,</span><br><span class="line">  unit: string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This object can describe what to be change (<code>target</code>, <code>property</code>), how long it will last (<code>duration</code>), how does the chnage looks like (<code>easing</code>), and the start and end value (<code>from</code>, <code>to</code> and <code>unit</code>).</p><p>An animation object group list of tweens and play the real animation by add it self to the engine and step the tween.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animation</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">tweens</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.tweens</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  step (now) &#123;</span><br><span class="line">    <span class="keyword">let</span> elapsed = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.startTime) &#123;</span><br><span class="line">       <span class="built_in">this</span>.startTime = now</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> elapsed = now - <span class="built_in">this</span>.startTime</span><br><span class="line">    finisheds = <span class="built_in">this</span>.tweens.map(<span class="function">(<span class="params">tween</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> process = <span class="built_in">Math</span>.min(<span class="number">1</span>, elapsed / tween.duration)</span><br><span class="line">      <span class="keyword">const</span> eased = tween.easing(process)</span><br><span class="line">      <span class="keyword">const</span> value = tween.from + (tween.to - tween.from) * eased</span><br><span class="line">      tween.target.style[tween.property] = value + tween.unit</span><br><span class="line">      <span class="keyword">if</span> (process &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (finisheds.every(<span class="function">(<span class="params">f</span>) =&gt;</span> f)) &#123;</span><br><span class="line">       <span class="built_in">this</span>.pause()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  play () &#123;</span><br><span class="line">    engine.add(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  pause () &#123;</span><br><span class="line">    engine.remove(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  restart () &#123;</span><br><span class="line">    <span class="built_in">this</span>.pause()</span><br><span class="line">    <span class="built_in">this</span>.startTime = <span class="number">0</span></span><br><span class="line">    <span class="built_in">this</span>.play()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2><span id="the-libraries">The Libraries</span></h2><p>Now we have <code>engine</code>, <code>tween</code> and <code>Animtaion</code>. Use those object or class you can build some style animatons you what to. But it’s not enough, we need construct the <code>tweens</code> ourself and we only support css style property animation.<br>There are some realy awesome animation libraries exist:</p><ul><li><a href="https://github.com/juliangarnier/anime">anime.js</a>: This is what inspire our little animation <code>engine</code> with   more features like <code>transform, svg and object property</code> (we can do it by add a <code>type</code> field to our <code>tween</code> and add the corresponding changes code to  <code>Animation.step</code> function), <code>timeline</code>, <code>can automaticlly transform params to tweens</code> etc.</li><li><a href="http://velocityjs.org/">velocityjs</a>: It’s incredibly fast, and it features color animation, transforms, loops, easings, SVG support, and scrolling.</li><li><a href="https://github.com/drcmda/react-spring">react-spring</a>: data driven animation library.</li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API">Web Animations API</a>: The W3C</li></ul><h2><span id="others">Others</span></h2><h3><span id="unit-transfrom">Unit transfrom</span></h3><ol><li><a href="https://github.com/jquery/jquery/blob/master/src/css/adjustCSS.js">jquery.adjustCSS</a>: calculate the scale between current unit and the excepted unit, then apply the new united value.</li><li>velocityjs: <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fromUnit !== toUnit) &#123;</span><br><span class="line">  currentValue = <span class="string">`calc(<span class="subst">$&#123;<span class="keyword">from</span> * (<span class="number">1</span> - eased) + fromUnit&#125;</span> + <span class="subst">$&#123;to * eased + toUnit&#125;</span>)`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3><span id="flip-technique">FLIP Technique</span></h3><p>For list reordering stuff.<br><a href="https://aerotwist.com/blog/flip-your-animations/#the-general-approach">https://aerotwist.com/blog/flip-your-animations/#the-general-approach</a></p><blockquote><ul><li>Calculate the <em>First</em> position.</li><li>Calculate the <em>Last</em> position.</li><li><em>Invert</em> the positions</li><li><em>Play</em> the animation</li></ul></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;The-engine&quot;&gt;&lt;a href=&quot;#The-engine&quot; class=&quot;headerlink&quot; title=&quot;The engine&quot;&gt;&lt;/a&gt;The engine&lt;/h2&gt;&lt;p&gt;We need a mechanism to deal with &lt;a href=&quot;https://github.com/wangbinyq/writings/wiki/Html-Reflow-and-Layout-Thrashing&quot;&gt;layout thrashing&lt;/a&gt;. So we have an engine that group all animations into to a &lt;code&gt;requestAnimationFrame&lt;/code&gt; callback.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>DNS 解析详解</title>
    <link href="https://wangbinyq.github.io/dns/"/>
    <id>https://wangbinyq.github.io/dns/</id>
    <published>2018-02-28T16:36:20.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>大家都知道 DNS (Domain Name System, 域名系统), 是一个域名和 IP 地址映射系统. 通过 DNS 我们可以根据比较容易记住的域名而不是数字 IP 地址来访问网络资源.<br>本文主要使用 <code>dig</code> (ubuntu 上可以通过 <code>sudo apt install dnsutils</code> 安装) 工具来了解 DNS 的各方面.</p><span id="more"></span><h2><span id="0x01-cname-和-a-记录">0x01 CNAME 和 A 记录</span></h2><p>在 DNS 中, A 记录值表示的是真正的 IP 地址, 而 CNAME 相当于域名的别名.<br>我们来看一个例子, 新浪的 DNS 解析:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dig www.sina.com.cn</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 45272</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.sina.com.cn.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.sina.com.cn.0INCNAMEspool.grid.sinaedge.com.</span><br><span class="line">spool.grid.sinaedge.com. 280INA222.73.28.96</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:37:11 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 97</span><br></pre></td></tr></table></figure><p>其中 <code>QUESTION SECTION:</code> 表示我们要查找的是 <code>www.sina.com.cn</code> 的 A 记录, <code>ANSWER SECTION:</code> 返回了记录的结果.<br>这个查询返回了三条记录, 每条记录有五个字段分别代表了: 主机域名, TTL, 类型(IN 表示 Internet), DNS 记录类型以及记录值. DNS 记录类型如下图所示 (图片来自阿里云截图):</p><p>![dns record](/images/dns/dns record.png)</p><p><code>www.sina.com.cn</code> 有一个 CNAME和一个 A记录. 如果我们直接在浏览器中访问 CNAME 值或者 IP 地址, 会发现不能访问.</p><p><img src="/images/dns/error.png" alt="error"></p><p>这是因为新浪服务器拒绝了非 <code>www.sina.com.cn</code> 域名访问. 我们可以构造一个 HTTP header 来实现直接连接 IP 访问新浪:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl 222.73.28.96 -H <span class="string">&quot;Host: www.sina.com.cn&quot;</span></span></span><br></pre></td></tr></table></figure><p>这样就能返回正常的页面.</p><h2><span id="0x02-另一个例子">0x02 另一个例子</span></h2><p>再来看一个例子:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ dig baidu.com                    </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; baidu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 23153</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4000</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;baidu.com.INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">baidu.com.300INA111.13.101.208</span><br><span class="line">baidu.com.300INA123.125.114.144</span><br><span class="line">baidu.com.300INA220.181.57.216</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.1.6#53(192.168.1.6)</span><br><span class="line">;; WHEN: Wed Feb 28 13:53:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 86</span><br></pre></td></tr></table></figure><p>我们看到 <code>baidu.com</code> 返回了三个 A 记录地址. 那客户端应该选择哪一个作为服务器的 IP 地址呢?<br>这个需要看客户端的实现, 比如使用 <code>gethostbyname</code> 的话会选择一个 IP 地址返回,  <code>getaddrinfo</code> 会返回所有的地址.</p><h2><span id="0x03-ns-记录">0x03 NS 记录</span></h2><p>NS 记录是域名服务器记录，用来指定域名由哪个DNS服务器来进行解析.</p><p><code>dig</code> 可以添加 <code>+trace</code> 参数来获取完整 DNS 解析过程. 还是通过 <code>www.sina.com.cn</code> 作为例子.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dig www.sina.com.cn +trace</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; www.sina.com.cn +trace</span><br><span class="line">;; global options: +cmd</span><br><span class="line">.3600INNSd.root-servers.net.</span><br><span class="line">.3600INNSe.root-servers.net.</span><br><span class="line">.3600INNSf.root-servers.net.</span><br><span class="line">.3600INNSg.root-servers.net.</span><br><span class="line">.3600INNSh.root-servers.net.</span><br><span class="line">.3600INNSi.root-servers.net.</span><br><span class="line">.3600INNSj.root-servers.net.</span><br><span class="line">.3600INNSk.root-servers.net.</span><br><span class="line">.3600INNSl.root-servers.net.</span><br><span class="line">.3600INNSm.root-servers.net.</span><br><span class="line">.3600INNSa.root-servers.net.</span><br><span class="line">.3600INNSb.root-servers.net.</span><br><span class="line">.3600INNSc.root-servers.net.</span><br><span class="line">;; Received 1771 bytes from 192.168.1.6#53(192.168.1.6) in 0 ms</span><br><span class="line"></span><br><span class="line">cn.172800INNSb.dns.cn.</span><br><span class="line">cn.172800INNSns.cernet.net.</span><br><span class="line">cn.172800INNSc.dns.cn.</span><br><span class="line">cn.172800INNSd.dns.cn.</span><br><span class="line">cn.172800INNSa.dns.cn.</span><br><span class="line">cn.172800INNSg.dns.cn.</span><br><span class="line">cn.172800INNSf.dns.cn.</span><br><span class="line">cn.172800INNSe.dns.cn.</span><br><span class="line">cn.86400INDS41470 8 2 3623FB6E3B1F69C6855DA1E48D3A38236DD2EDF0380FB018FF538650 EAC2C4DD</span><br><span class="line">cn.86400INDS57724 8 2 5D0423633EB24A499BE78AA22D1C0C9BA36218FF49FD95A4CDF1A4AD 97C67044</span><br><span class="line">cn.86400INRRSIGDS 8 1 86400 20180313050000 20180228040000 41824 . GbRg9UYKus5nqvJxCKVZTaX5j2WYaF2c3jH5XOEPzqgcGp23+U941ZHz nKAXTv8oJq2+dJiRuVnwAD7c+Ge8MBJbd+tpw0jcQ3zs3SiocVhWgF3/ Bjig8ouJsuKukEuF89tx+oqbYjRrau9PFNJBoN2zlVZP1JQYTukYaGeY aK91OtgRuC1yVVQqNstLhU+YWyi7gNKOd31SMSpyvUZDIf+8wQrR6j9y dUb7zex8dk+XFS9/NqOXi6kRQxOPdflXXGieNZRVAnHfKdgO3LsXYmsD 92CY9G7cwj9XShFdYq7GLSirh3c9LvUR4E0VKk6qcr3usgKbmDPumyAv aN+ZwA==</span><br><span class="line">;; Received 754 bytes from 192.33.4.12#53(c.root-servers.net) in 173 ms</span><br><span class="line"></span><br><span class="line">sina.com.cn.86400INNSns3.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns2.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns1.sina.com.cn.</span><br><span class="line">sina.com.cn.86400INNSns4.sina.com.cn.</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN NSEC31 1 10 AEF123AB HIO2MHL5BSKBHFFRA5I1J58SU91CDLLA NS SOA RRSIG DNSKEY NSEC3PARAM</span><br><span class="line">GICE14DNTMDN31G43AUGVRKTKALVB8QC.com.cn. 21600 IN RRSIGNSEC3 8 3 21600 20180318092826 20180216084403 48018 com.cn. iuUIwe/vd4QLsTo8behQVf8ZPWaU9JsP+gxrUHop+oybuZH+II+kvOBW wTfGHap/n3C7iSevN80Wa2eFeH0QBWif2A30+zfg9hCzVjEEUDulmc1a 4+ltDbv4UZVJpBPRU7n2AgW4UMK/q0vyWqV6oKwmIygj58fhrMkqcrpR CpU=</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN NSEC31 1 10 AEF123AB UQROTQK62NOIM5U43DMF7AMC8JJFRM7T NS DS RRSIG</span><br><span class="line">T1MQAIVAIU5JVK5ON55K8AOCE62H72MI.com.cn. 21600 IN RRSIGNSEC3 8 3 21600 20180311113832 20180209104700 48018 com.cn. I1zxGBgSFJfq5GCrwlukCCkWNeQRcJJu9ydX5OgoH0mdYwVVLGoB2y1D htn8lGc4MMfdbY+zTdlnvYvBHdtFSS2+2eq+ficKzzZQ2CVtDrFm91Eo 0MK+BavvLcE5pkRpIfpI9FIIMrlNaj9cOBwWNR2g1yXfSYWSr5NUFKQG voE=</span><br><span class="line">;; Received 679 bytes from 203.119.25.1#53(a.dns.cn) in 33 ms</span><br><span class="line"></span><br><span class="line">www.sina.com.cn.0INCNAMEspool.grid.sinaedge.com.</span><br><span class="line">;; Received 81 bytes from 61.172.201.254#53(ns2.sina.com.cn) in 5 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们最上面域名为 <code>.</code> (根域名) 的 NS 记录, 一共有 13 条, 代表了 13 台根域名服务器. 接下来是在根域名服务器上查询 <code>cn.</code> (实际中最后一个点去掉) 得到的 8 条 NS 记录, 代表了顶级域名服务器. 然后是顶级域名服务器查询 <code>sina.com.cn</code> 得到的 4 条 NS 记录, 代表了授权域名服务器, 最后授权 DNS 返回了 <code>www.sina.com.cn</code> 的 CNAME 记录.</p><div class="tip">授权域名服务器: 我们知道计算机要上网的话, 必须要设置 DNS (除非只用 IP), 或者 ISP 自动分配 DNS. 这个 DNS 服务器是叫做 LocalDNS, 提供了缓存和递归查询服务. 如果查询一个域名在 LocalDNS 上已经有缓存了, LocalDNS 直接返回结果 (叫做非授权应答); 如果 LocalDNS 上没有这个域名的话, LocalDNS 就要对域名发起递归查找(类似 dig +trace 的过程), 就是从根域名 -> 顶级域名 -> 授权域名查找这个域名, 并将应答返回, 同时缓存应答(可以看出根域名, 顶级域名也是授权域名服务器). 一般宽带运行商和公共DNS服务提供的是 LocalDNS, 域名注册商提供的是授权DNS.</div><p>假如我在阿里云上注册了一个域名 (example.com), 其 NS 记录就是 dns14.hichina.com 和 dns13.hichina.com (万网的授权域名服务器), 我们还可以设置 NS 记录指向其他的授权域名服务器.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;大家都知道 DNS (Domain Name System, 域名系统), 是一个域名和 IP 地址映射系统. 通过 DNS 我们可以根据比较容易记住的域名而不是数字 IP 地址来访问网络资源.&lt;br&gt;本文主要使用 &lt;code&gt;dig&lt;/code&gt; (ubuntu 上可以通过 &lt;code&gt;sudo apt install dnsutils&lt;/code&gt; 安装) 工具来了解 DNS 的各方面.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://wangbinyq.github.io/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Guide</title>
    <link href="https://wangbinyq.github.io/hexo-guide/"/>
    <id>https://wangbinyq.github.io/hexo-guide/</id>
    <published>2018-02-28T16:06:20.000Z</published>
    <updated>2021-09-29T05:51:19.917Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><span id="more"></span><h2><span id="quick-start">Quick Start</span></h2><h3><span id="create-a-new-post">Create a new post</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3><span id="run-server">Run server</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3><span id="generate-static-files">Generate static files</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3><span id="deploy-to-remote-sites">Deploy to remote sites</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;</summary>
    
    
    
    
    <category term="hexo" scheme="https://wangbinyq.github.io/tags/hexo/"/>
    
  </entry>
  
</feed>
